@page "/"

@using Microsoft.AspNetCore.Components.Web
@using dfd2wasm.Services
@using dfd2wasm.Models

<div class="dfd-container" tabindex="0" @onkeydown="HandleKeyDown">
    <div class="toolbar">
        <h1 @onclick="@(() => showAboutDialog = true)" style="cursor: pointer;" title="Click for About">DFD Editor v2</h1>
        
        <div class="zoom-controls">
            <button @onclick="ZoomOut" disabled="@(zoomLevel <= 0.25)" title="Zoom Out">−</button>
            <input type="range" 
                   min="25" max="300" step="5" 
                   value="@((int)(zoomLevel * 100))"
                   @onchange="@(e => zoomLevel = int.Parse(e.Value?.ToString() ?? "100") / 100.0)"
                   class="zoom-slider"
                   title="Zoom: @((int)(zoomLevel * 100))%" />
            <span class="zoom-level">@((int)(zoomLevel * 100))%</span>
            <button @onclick="ZoomIn" disabled="@(zoomLevel >= 3.0)" title="Zoom In">+</button>
            <button @onclick="@(() => zoomLevel = 1.0)" title="Reset Zoom">⟲</button>
            <button @onclick="ZoomToFit" title="Zoom to Fit">⊡</button>
        </div>

        <div class="toolbar-buttons">
            @* Select Mode Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger @(mode == EditorMode.Select ? "active" : "")">
                    ✋ Select @(GetSelectModeLabel()) ▾
                </button>
                <div class="dropdown-menu">
                    <button class="@(mode == EditorMode.Select && !chainMode && connectionMode == ConnectionModeType.Normal ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; chainMode = false; connectionMode = ConnectionModeType.Normal; ClearOneToNState(); })">
                        ✋ Single Select
                    </button>
<button class="@(chainMode ? "active" : "")"
        @onclick="@(() => { 
            mode = EditorMode.Select; 
            chainMode = !chainMode; 
            if (chainMode) { 
                connectionMode = ConnectionModeType.Normal; 
                ClearOneToNState(); 
            } 
            lastChainedNodeId = null; 
        })"
        title="Click nodes in sequence to connect them">
    🔗 Chain Connect
</button>
                    <button class="@(connectionMode == ConnectionModeType.OneToN ? "active" : "")"
                            @onclick="@(() => { mode = EditorMode.Select; connectionMode = ConnectionModeType.OneToN; chainMode = false; ClearOneToNState(); })"
                            title="Select source, then click multiple destinations">
                        🔀 1:N Connect
                    </button>
                </div>
            </div>

            @* Add Shape Button *@
            <button class="@(mode == EditorMode.AddNode ? "active" : "")"
                    @onclick="@(() => { mode = EditorMode.AddNode; chainMode = false; multiConnectMode = false; ClearMultiConnectState(); })">
                ➕ Add Shape
            </button>

            @* Place Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger @(arrayMode || snapToGrid || useOrthoPlacement ? "active" : "")">
                    📐 Options ▾
                </button>
                <div class="dropdown-menu">
                    <button class="@(useOrthoPlacement ? "active" : "")"
                            @onclick="@(() => ToggleOrthoMode())"
                            title="Use orthogonal edges">
                        📐 Ortho Mode @(useOrthoPlacement ? "✓" : "")
                    </button>
                    <button class="@(snapToGrid ? "active" : "")"
                            @onclick="@(() => snapToGrid = !snapToGrid)">
                        🧲 Snap to Grid @(snapToGrid ? "✓" : "")
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="@(arrayMode ? "active" : "")"
                            @onclick="@(() => { arrayMode = !arrayMode; if (arrayMode) mode = EditorMode.AddNode; })"
                            title="Place multiple shapes at once">
                        📊 Array Mode @(arrayMode ? "✓" : "")
                    </button>
                    @if (arrayMode)
                    {
                        <div class="dropdown-submenu">
                            <span class="submenu-label">Orientation:</span>
                            <button class="@(arrayOrientation == "horizontal" ? "active" : "")"
                                    @onclick="@(() => arrayOrientation = "horizontal")">
                                Horizontal ███
                            </button>
                            <button class="@(arrayOrientation == "vertical" ? "active" : "")"
                                    @onclick="@(() => arrayOrientation = "vertical")">
                                Vertical
                            </button>
                            <span class="submenu-label">Count:</span>
                            <select @bind="arrayCount" class="dropdown-select">
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                    }
                </div>
            </div>

            @* Align Dropdown - only when 2+ nodes selected *@
            @if (selectedNodes.Count >= 2)
            {
                <div class="toolbar-dropdown">
                    <button class="dropdown-trigger">
                        📏 Align ▾
                    </button>
                    <div class="dropdown-menu dropdown-menu-wide">
                        <div class="dropdown-row">
                            <span class="submenu-label">Horizontal:</span>
                            <button @onclick="AlignLeft" title="Align Left">⬅ Left</button>
                            <button @onclick="AlignCenterH" title="Align Center">⬌ Center</button>
                            <button @onclick="AlignRight" title="Align Right">➡ Right</button>
                        </div>
                        <div class="dropdown-row">
                            <span class="submenu-label">Vertical:</span>
                            <button @onclick="AlignTop" title="Align Top">⬆ Top</button>
                            <button @onclick="AlignCenterV" title="Align Center">⬍ Center</button>
                            <button @onclick="AlignBottom" title="Align Bottom">⬇ Bottom</button>
                        </div>
                        @if (selectedNodes.Count >= 3)
                        {
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-row">
                                <span class="submenu-label">Distribute:</span>
                                <button @onclick="DistributeH" title="Distribute Horizontally">↔ Horizontal</button>
                                <button @onclick="DistributeV" title="Distribute Vertically">↕ Vertical</button>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Examples Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger" @onclick="@(() => showExamplesMenu = !showExamplesMenu)">
                    📋 Examples ▾
                </button>
                @if (showExamplesMenu)
                {
                    <div class="dropdown-menu">
                        @foreach (var example in Examples)
                        {
                            <button @onclick="@(() => LoadExample(example.Key))" title="@example.Value.Description">
                                @example.Value.Name
                            </button>
                        }
                    </div>
                }
            </div>

            @* Export/Print Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger">
                    🖨️ Print ▾
                </button>
                <div class="dropdown-menu">
                    <button @onclick="TogglePrintAreaSelection"
                            class="@(isPrintAreaSelection ? "active" : "")"
                            title="Draw a box around the area to export">
                        📄 @(isPrintAreaSelection ? "Cancel Selection" : "Select Area")
                    </button>
                    <button @onclick="PrintAll"
                            title="Print entire canvas">
                        🖨️ Print All
                    </button>
                </div>
            </div>


            @* Layout Dropdown *@
            <div class="toolbar-dropdown">
                <button class="dropdown-trigger">
                    ⚡ Layout ▾
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section-header">📐 Auto Layout</div>
                    <button @onclick="ApplyForceDirectedLayout" title="Organic layout using physics simulation">
                        🔀 Force-Directed
                    </button>
                    <button @onclick="ApplySugiyamaLayout" title="Hierarchical top-to-bottom layout">
                        📊 Hierarchical
                    </button>
                    <button @onclick="ApplyTreeLayout" title="Tree layout (select a node for root)">
                        🌳 Tree @(selectedNodes.Count == 1 ? "(from selected)" : "")
                    </button>
                    <button @onclick="ApplyCircleLayout" title="Arrange nodes in a circle">
                        ⭕ Circle
                    </button>
                    <button @onclick="ApplyGridLayout" title="Arrange nodes in a grid">
                        ▦ Grid
                    </button>
                    <button @onclick="ApplyRadialLayout" title="Radial layout from center">
                        🎯 Radial @(selectedNodes.Count == 1 ? "(from selected)" : "")
                    </button>
                    <button @onclick="ApplyCompactLayout" title="Move nodes closer together">
                        📦 Compact
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🔄 Transform</div>
                    <button @onclick="FlipHorizontal" title="Flip layout horizontally (mirror left-right)">
                        ↔️ Flip Horizontal
                    </button>
                    <button @onclick="FlipVertical" title="Flip layout vertically (mirror top-bottom)">
                        ↕️ Flip Vertical
                    </button>
                    <button @onclick="ApplySymmetricHorizontal" title="Arrange nodes symmetrically left-right">
                        ⚖️ Symmetric H
                    </button>
                    <button @onclick="ApplySymmetricVertical" title="Arrange nodes symmetrically top-bottom">
                        ⚖️ Symmetric V
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🔗 Edge Routing</div>
                    <button @onclick="MinimizeEdgeCrossings" title="Reduce edge crossings">
                        ✂️ Minimize Crossings (@GetEdgeCrossingCount())
                    </button>
                    <button @onclick="RouteEdgesOrthogonal" title="Route edges at right angles">
                        📐 Orthogonal Routing
                    </button>
                    <button @onclick="BundleParallelEdges" title="Bundle parallel edges together">
                        📦 Bundle Edges
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🎨 Edge Style (All)</div>
                    <button @onclick="SetAllEdgesDirect" title="Set all edges to straight lines">
                        ➡️ All Direct
                    </button>
                    <button @onclick="SetAllEdgesOrtho" title="Set all edges to right angles">
                        📐 All Orthogonal
                    </button>
                    <button @onclick="SetAllEdgesBezier" title="Set all edges to smooth curves">
                        〰️ All Bezier
                    </button>
                    <button @onclick="ClearAllWaypoints" title="Remove all edge waypoints">
                        🧹 Clear Waypoints
                    </button>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-section-header">🧠 Optimization</div>
                    <button @onclick="OptimizeLayoutSimulatedAnnealing" 
                            disabled="@isOptimizing"
                            title="Simulated annealing optimization">
                        @(isOptimizing ? $"⏳ {optimizationProgress}%" : "🎯 Optimize Layout")
                    </button>
                    <button @onclick="QuickRemoveOverlaps">📦 Remove Overlaps</button>
                    <button @onclick="SnapAllToGrid">📐 Snap to Grid</button>
                    <button @onclick="@(() => showOptimizationSettings = !showOptimizationSettings)">
                        ⚙️ Settings @(showOptimizationSettings ? "▲" : "▼")
                    </button>
                    @if (showOptimizationSettings)
                    {
                        <div class="optimization-settings">
                            <div class="setting-row">
                                <label>Iterations: @annealingIterations</label>
                                <input type="range" min="1000" max="20000" step="1000" @bind="annealingIterations" />
                            </div>
                            <div class="setting-row">
                                <label>Cooling: @annealingCooling.ToString("F3")</label>
                                <input type="range" min="0.9" max="0.999" step="0.001" @bind="annealingCooling" />
                            </div>
                            <div class="preset-buttons">
                                <button @onclick="ApplyQuickPreset">⚡Quick</button>
                                <button @onclick="ApplyBalancedPreset">⚖️Balanced</button>
                                <button @onclick="ApplyThoroughPreset">🔬Thorough</button>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @* Undo Button *@
            <button @onclick="HandleUndo"
                    disabled="@(!UndoService.CanUndo)"
                    title="Undo last action (Ctrl+Z)">
                ↶ Undo
            </button>

            @* Contextual buttons for selected node *@
            @if (selectedNodes.Count == 1)
            {
                <button @onclick="StartEditingSelectedNode"
                        title="Edit the text of the selected node">
                    ✏️ Edit
                </button>
                <button @onclick="RearrangeSelectedNodeEdges"
                        title="Rearrange edges on this node to reduce crossings">
                    🔄 Fix Edges
                </button>
            }

            @if (selectedLabels.Count == 1)
            {
                <button @onclick="StartEditingSelectedLabel"
                        title="Edit the selected label">
                    ✏️ Edit Label
                </button>
            }
        </div>

        @* File Actions *@
        <div class="toolbar-dropdown toolbar-right">
            <button class="dropdown-trigger">
                📁 File ▾
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <button @onclick="SaveDiagram" title="Export diagram as JSON">
                    💾 Save JSON
                </button>
                <button @onclick="@(() => showLoadDialog = true)" title="Import from JSON, Mermaid, or GraphViz">
                    📥 Import
                </button>
                <button @onclick="ExportDiagram" title="Export as Mermaid or DOT">
                    📤 Export Code
                </button>
                <div class="dropdown-divider"></div>
                <button @onclick="@(() => showClearConfirm = true)" class="btn-danger" title="Clear all">
                    🗑️ Clear All
                </button>
            </div>
        </div>
    </div>

    @* Multi-Connect Mode Indicator *@
    @if (multiConnectMode)
    {
        <div class="mode-indicator multi-connect-indicator">
            @if (multiConnectSourceNode == null)
            {
                <span>🔀 <b>Multi-Connect:</b> Click a connection point on the SOURCE node</span>
            }
            else
            {
                <span>🔀 <b>Source selected!</b> Now click connection points on DESTINATION nodes • <b>Esc</b> to finish</span>
            }
        </div>
    }
    @if (chainMode)
    {
        <div class="mode-indicator chain-indicator">
            <span>🔗 <b>Chain Mode:</b> Click nodes in sequence to connect them • <b>Esc</b> to finish</span>
        </div>
    }

    @* Layout Processing Indicator *@
    @if (isLayoutProcessing)
    {
        <div class="layout-processing-overlay">
            <div class="layout-processing-modal">
                <div class="spinner"></div>
                <span>@layoutStatusMessage</span>
            </div>
        </div>
    }

    <div class="instructions">
        <strong>Instructions:</strong>
        @if (isPrintAreaSelection)
        {
            <span> 📄 Print Selection Mode: Click and drag to draw a box around the area you want to export to PDF</span>
        }
        else if (chainMode)
        {
            <span> 🔗 <strong style="color: #8b5cf6;">Chain Mode:</strong> Click nodes in sequence to connect them. @(lastChainedNodeId.HasValue ? $"Last node: #{lastChainedNodeId}" : "Click first node to start chain") | Click 🔗 Chain again to exit</span>
        }
        else if (arrayMode)
        {
            <span> 📊 Array Mode: Click to place @arrayCount shapes in @arrayOrientation array | Spacing: @arraySpacing px</span>
        }
        else if (pendingConnectionNodeId.HasValue)
        {
            <span> 🎯 Hover over target node to see <strong style="color: #f59e0b;">orange connection points</strong>, then click one to complete the edge | Or click an edge to reattach endpoint</span>
        }
        else if (mode == EditorMode.AddNode)
        {
            <span> 📍 Click canvas to add shape @(useOrthoPlacement ? "(Ortho mode: aligned placement + orthogonal edges)" : "")</span>
        }
        else if (selectedNodes.Count == 0 && selectedEdges.Count == 0)
        {
            <span> <strong>Shift+Click</strong> = multi-select nodes/edges | Click node → node = arrow | <strong>Alt+Click edge</strong> = waypoint | <strong>Ctrl+Shift+Click edge</strong> = label | <strong>Delete</strong> = remove selected</span>
        }
        else if (selectedEdges.Count > 0)
        {
            <span> ✏️ <strong style="color: #3b82f6;">@selectedEdges.Count edge(s) selected</strong> - <strong>Shift+Click</strong> more edges to add | Adjust Edge Style and click <strong>Apply</strong> | <strong style="color: #10b981;">Click green dots</strong> to reconnect | <strong>Delete</strong> to remove</span>
        }
        else
        {
            <span> 🎯 <strong>@selectedNodes.Count node(s) selected</strong> | Press <strong>Delete</strong> to remove | <strong style="color: #10b981;">Green dots</strong> = connection points (5 per side) | <strong>Shift+Click</strong> = multi-select more</span>
        }
    </div>

    <div class="main-content">
        <div class="side-panel left-panel @(isLeftPanelCollapsed ? "collapsed" : "")">
            <button class="panel-collapse-toggle" @onclick="@(() => isLeftPanelCollapsed = !isLeftPanelCollapsed)" title="@(isLeftPanelCollapsed ? "Expand panel" : "Collapse panel")">
                @(isLeftPanelCollapsed ? "▶" : "◀")
            </button>
            @if (!isLeftPanelCollapsed)
            {
            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseCanvas = !collapseCanvas)">
                    <span>🎨 Canvas</span>
                    <span class="collapse-icon">@(collapseCanvas ? "▶" : "▼")</span>
                </button>
                @if (!collapseCanvas)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Background</label>
                            <select @bind="canvasBackground" class="panel-select">
                                <option value="grid">Grid</option>
                                <option value="swimlanes-h">Swimlanes (H)</option>
                                <option value="swimlanes-v">Swimlanes (V)</option>
                                <option value="columns">Columns</option>
                                <option value="none">None</option>
                            </select>
                            @if (canvasBackground.StartsWith("swimlanes") || canvasBackground == "columns")
                            {
                                <button class="panel-btn" @onclick="@(() => showBackgroundConfig = true)">
                                    ⚙️ Configure
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseShape = !collapseShape)">
                    <span>⬡ Shape</span>
                    <span class="collapse-icon">@(collapseShape ? "▶" : "▼")</span>
                </button>
                @if (!collapseShape)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Template</label>
                            <select value="@selectedTemplateId" @onchange="OnTemplateChanged" class="panel-select">
                                <option value="">— Basic Shapes —</option>
                                @foreach (var tpl in GetAvailableTemplates())
                                {
                                    <option value="@tpl.Id">@tpl.DisplayName</option>
                                }
                            </select>
                        </div>
                        @if (string.IsNullOrEmpty(selectedTemplateId))
                        {
                            <div class="property-group">
                                <label>Shape</label>
                                <select @bind="selectedShape" class="panel-select">
                                    <option value="@NodeShape.Rectangle">Rectangle</option>
                                    <option value="@NodeShape.Ellipse">Ellipse</option>
                                    <option value="@NodeShape.Diamond">Diamond</option>
                                    <option value="@NodeShape.Parallelogram">Parallelogram</option>
                                    <option value="@NodeShape.Cylinder">Cylinder</option>
                                </select>
                            </div>
                        }
                        else
                        {
                            <div class="property-group">
                                <label>Shape</label>
                                <select value="@selectedTemplateShapeId" @onchange="OnTemplateShapeChanged" class="panel-select">
                                    @foreach (var shape in GetShapesForTemplate(selectedTemplateId))
                                    {
                                        <option value="@shape.Id">@shape.DisplayName</option>
                                    }
                                </select>
                            </div>
                            @* Template-specific edge style info *@
                            <div class="template-edge-info">
                                <span class="info-label">Edge style:</span>
                                <span class="info-value">
                                    @(GetCurrentEdgeDefaults().ArrowDirection == ArrowDirection.None ? "No arrows" :
                                      GetCurrentEdgeDefaults().ArrowDirection == ArrowDirection.Both ? "Bidirectional" :
                                      GetCurrentEdgeDefaults().ArrowDirection == ArrowDirection.Start ? "Reverse arrow" : "Forward arrow")
                                    @(GetCurrentEdgeDefaults().EdgeStyle == EdgeStyle.Ortho ? " (Ortho)" : "")
                                </span>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseEdgeStyle = !collapseEdgeStyle)">
                    <span>✏️ @(selectedNodes.Count > 0 ? "Stroke Style" : "Edge Style")</span>
                    <span class="collapse-icon">@(collapseEdgeStyle ? "▶" : "▼")</span>
                </button>
                @if (!collapseEdgeStyle)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Width & Style</label>
                            <div class="property-row">
                                <select @bind="defaultStrokeWidth" class="panel-select-small">
                                    <option value="1">1px</option>
                                    <option value="2">2px</option>
                                    <option value="3">3px</option>
                                    <option value="4">4px</option>
                                    <option value="5">5px</option>
                                </select>
                                <select @bind="defaultStrokeDashArray" class="panel-select-small">
                                    @foreach (var style in lineStyles)
                                    {
                                        <option value="@style.Key">@style.Value</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="property-group">
                            <label>Color</label>
                            <div class="panel-color-picker">
                                @foreach (var color in presetColors)
                                {
                                    <button class="color-swatch-small @(defaultStrokeColor == color ? "selected" : "")"
                                            style="background-color: @color;"
                                            @onclick="@(() => { defaultStrokeColor = color; ApplyStrokeToSelection(); })"
                                            title="@color">
                                    </button>
                                }
                            </div>
                        </div>
                        <div class="property-group">
                            <label class="panel-checkbox">
                                <input type="checkbox" @bind="defaultIsDoubleLine" />
                                Double Line
                            </label>
                        </div>
                        @if (selectedNodes.Count > 0)
                        {
                            <button class="panel-btn-primary" @onclick="ApplyStrokeToSelectedNodes">
                                ✓ Apply to @selectedNodes.Count node(s)
                            </button>
                        }
                        else if (selectedEdges.Count > 0)
                        {
                            <button class="panel-btn-primary" @onclick="ApplyEdgeStylesToSelected">
                                ✓ Apply to @selectedEdges.Count edge(s)
                            </button>
                        }
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseProperties = !collapseProperties)">
                    <span>📋 Properties</span>
                    <span class="collapse-icon">@(collapseProperties ? "▶" : "▼")</span>
                </button>
                @if (!collapseProperties)
                {
                    <div class="section-content">
                        @if (selectedNodes.Count == 1)
                        {
                            var node = nodes.FirstOrDefault(n => n.Id == selectedNodes[0]);
                            @if (node != null)
                            {
                                <div class="property-group">
                                    <label>Position</label>
                                    <div class="property-row">
                                        <span>X:</span>
                                        <input type="number" value="@((int)node.X)" @onchange="@(e => { node.X = double.Parse(e.Value?.ToString() ?? "0"); RecalculateEdgePaths(node.Id); })" />
                                    </div>
                                    <div class="property-row">
                                        <span>Y:</span>
                                        <input type="number" value="@((int)node.Y)" @onchange="@(e => { node.Y = double.Parse(e.Value?.ToString() ?? "0"); RecalculateEdgePaths(node.Id); })" />
                                    </div>
                                </div>
                                <div class="property-group">
                                    <label>Size</label>
                                    <div class="property-row">
                                        <span>W:</span>
                                        <input type="number" value="@((int)node.Width)" @onchange="@(e => { node.Width = double.Parse(e.Value?.ToString() ?? "120"); })" />
                                    </div>
                                    <div class="property-row">
                                        <span>H:</span>
                                        <input type="number" value="@((int)node.Height)" @onchange="@(e => { node.Height = double.Parse(e.Value?.ToString() ?? "60"); })" />
                                    </div>
                                </div>
                                <div class="property-group">
                                    <label>Node Color</label>
                                    <div class="panel-color-picker">
                                        @foreach (var color in presetColors)
                                        {
                                            <button class="color-swatch-small @(node.StrokeColor == color ? "selected" : "")"
                                                    style="background-color: @color;"
                                                    @onclick="@(() => node.StrokeColor = color)"
                                                    title="@color">
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else if (selectedNodes.Count > 1)
                        {
                            <p class="panel-info">@selectedNodes.Count nodes selected</p>
                            <div class="property-group">
                                <label>Node Color</label>
                                <div class="panel-color-picker">
                                    @foreach (var color in presetColors)
                                    {
                                        <button class="color-swatch-small"
                                                style="background-color: @color;"
                                                @onclick="@(() => { foreach (var id in selectedNodes) { var n = nodes.FirstOrDefault(x => x.Id == id); if (n != null) n.StrokeColor = color; } })"
                                                title="@color">
                                        </button>
                                    }
                                </div>
                            </div>
                            <p class="panel-hint">Use alignment tools in toolbar</p>
                        }
                        else
                        {
                            <p class="panel-hint">Select a node to edit</p>
                        }
                    </div>
                }
            </div>
            }
        </div>

        <div class="canvas @(canvasBackground == "grid" ? "grid-background" : "")"
         @ref="canvasRef"
         @onmousedown="HandleCanvasMouseDown"
         @onmousemove="HandleCanvasMouseMove"
         @onmouseup="HandleCanvasMouseUp"
         @onclick="HandleCanvasClick"
         @onscroll="HandleCanvasScroll">
        <svg class="svg-layer" style="transform: scale(@zoomLevel); transform-origin: 0 0;">
           <defs>
                @* End arrowhead markers for each edge color *@
                @foreach (var color in edges.Where(e => !string.IsNullOrEmpty(e.StrokeColor)).Select(e => e.StrokeColor).Distinct())
                {
                    <marker id="arrowhead-@color.Replace("#", "")" 
                            markerWidth="8" markerHeight="6"
                            refX="7" refY="3" 
                            orient="auto" 
                            markerUnits="strokeWidth">
                        <polygon points="0 0, 8 3, 0 6" fill="@color" />
                    </marker>
                }
                @* Default end arrowhead *@
                <marker id="arrowhead" 
                        markerWidth="8" markerHeight="6"
                        refX="7" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="0 0, 8 3, 0 6" fill="#374151" />
                </marker>
                @* Default gray end arrowhead for 374151 color *@
                <marker id="arrowhead-374151" 
                        markerWidth="8" markerHeight="6"
                        refX="7" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="0 0, 8 3, 0 6" fill="#374151" />
                </marker>
                
                @* Start arrowhead markers (pointing backward) for each edge color *@
                @foreach (var color in edges.Where(e => !string.IsNullOrEmpty(e.StrokeColor)).Select(e => e.StrokeColor).Distinct())
                {
                    <marker id="arrowhead-start-@color.Replace("#", "")" 
                            markerWidth="8" markerHeight="6"
                            refX="1" refY="3" 
                            orient="auto" 
                            markerUnits="strokeWidth">
                        <polygon points="8 0, 0 3, 8 6" fill="@color" />
                    </marker>
                }
                @* Default start arrowhead *@
                <marker id="arrowhead-start" 
                        markerWidth="8" markerHeight="6"
                        refX="1" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="8 0, 0 3, 8 6" fill="#374151" />
                </marker>
                @* Default gray start arrowhead for 374151 color *@
                <marker id="arrowhead-start-374151" 
                        markerWidth="8" markerHeight="6"
                        refX="1" refY="3" 
                        orient="auto"
                        markerUnits="strokeWidth">
                    <polygon points="8 0, 0 3, 8 6" fill="#374151" />
                </marker>
            </defs>            @* Dynamic Canvas Background *@
            @if (canvasBackground == "swimlanes-h")
            {
                @* Horizontal Swimlanes *@
                var laneHeight = 2000.0 / swimlaneCount;
                var labelColumnWidth = 80.0; // Width for label column
                
                @* Label column background *@
                <rect x="0" y="0" width="@labelColumnWidth" height="2000"
                      fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"
                      style="pointer-events: none;" />
                
                for (int i = 0; i < swimlaneCount; i++)
                {
                    var y = i * laneHeight;
                    var fillColor = i % 2 == 0 ? "#f9fafb" : "#ffffff";
                    var labelText = swimlaneLabels.Count > i ? swimlaneLabels[i] : $"Lane {i + 1}";

                    @* Swimlane background (starts after label column) *@
                    <rect x="@labelColumnWidth" y="@y" width="@(2000 - labelColumnWidth)" height="@laneHeight"
                          fill="@fillColor" stroke="#e5e7eb" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Horizontal separator in label column *@
                    <line x1="0" y1="@y" x2="@labelColumnWidth" y2="@y"
                          stroke="#9ca3af" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Vertical text label in the column *@
                    @RenderSvgText(labelText, labelColumnWidth / 2, y + laneHeight / 2, 
                        "middle", "middle", "14", "bold", "#374151", 
                        $"rotate(-90 {labelColumnWidth / 2} {y + laneHeight / 2})")
                }
            }
            else if (canvasBackground == "swimlanes-v")
            {
                @* Vertical Swimlanes *@
                var laneWidth = 2000.0 / swimlaneCount;
                var labelRowHeight = 40.0; // Height for label row
                
                @* Label row background *@
                <rect x="0" y="0" width="2000" height="@labelRowHeight"
                      fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"
                      style="pointer-events: none;" />
                
                for (int i = 0; i < swimlaneCount; i++)
                {
                    var x = i * laneWidth;
                    var fillColor = i % 2 == 0 ? "#f9fafb" : "#ffffff";
                    var labelText = swimlaneLabels.Count > i ? swimlaneLabels[i] : $"Lane {i + 1}";

                    @* Swimlane background (starts below label row) *@
                    <rect x="@x" y="@labelRowHeight" width="@laneWidth" height="@(2000 - labelRowHeight)"
                          fill="@fillColor" stroke="#e5e7eb" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Vertical separator in label row *@
                    <line x1="@x" y1="0" x2="@x" y2="@labelRowHeight"
                          stroke="#9ca3af" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Text label in the row *@
                    @RenderSvgText(labelText, x + laneWidth / 2, labelRowHeight / 2, 
                        "middle", "middle", "14", "bold", "#374151")
                }
            }
            else if (canvasBackground == "columns")
            {
                @* Vertical Columns with labels *@
                var columnWidth = 2000.0 / columnCount;
                var labelRowHeight = 40.0; // Height for label row
                
                @* Label row background *@
                <rect x="0" y="0" width="2000" height="@labelRowHeight"
                      fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"
                      style="pointer-events: none;" />

                for (int i = 0; i < columnCount; i++)
                {
                    var x = i * columnWidth;
                    var labelText = columnLabels.Count > i ? columnLabels[i] : $"Column {i + 1}";

                    @* Column guide line (starts below label row) *@
                    <line x1="@x" y1="@labelRowHeight" x2="@x" y2="2000"
                          stroke="#e5e7eb" stroke-width="2" stroke-dasharray="10,5"
                          style="pointer-events: none;" />
                    
                    @* Vertical separator in label row *@
                    <line x1="@x" y1="0" x2="@x" y2="@labelRowHeight"
                          stroke="#9ca3af" stroke-width="2"
                          style="pointer-events: none;" />
                    
                    @* Text label in the row *@
                    @RenderSvgText(labelText, x + columnWidth / 2, labelRowHeight / 2, 
                        "middle", "middle", "14", "bold", "#374151")
                }
            }

            @* Row guides - horizontal lines (when enabled) *@
            @if (showRowGuide)
            {
                @for (int i = 1; i <= 3; i++)
                {
                    var y = i * 500;
                    <line x1="0" y1="@y" x2="2000" y2="@y"
                          stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5"
                          style="pointer-events: none;" />
                    @RenderRowGuideLabel(y, i)
                }
            }

            @* Column guides - vertical lines (when enabled) *@
            @if (showColumnGuide)
            {
                @for (int i = 1; i <= 3; i++)
                {
                    var x = i * 500;
                    <line x1="@x" y1="0" x2="@x" y2="2000"
                          stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5"
                          style="pointer-events: none;" />
                    @RenderColumnGuideLabel(x, i)
                }
            }

            @* Canvas boundary *@
            <rect x="0" y="0" width="4000" height="4000"
                  fill="none" stroke="#cbd5e1" stroke-width="2"
                  style="pointer-events: none;" />

            @* Render all edges *@
            @foreach (var edge in edges)
            {
                try
                {
                    // Skip edges that don't have PathData calculated yet
                    if (string.IsNullOrEmpty(edge.PathData))
                    {
                        Console.WriteLine($"Edge {edge.Id} has no PathData, skipping render");
                        continue;
                    }

                    var isSelected = selectedEdges.Contains(edge.Id);
                    var strokeColor = isSelected ? "#3b82f6" : (edge.StrokeColor ?? "#374151");
                    var strokeWidth = isSelected ? 4 : (edge.StrokeWidth ?? 2);
                    var dashArray = edge.StrokeDashArray ?? "";
                    var currentEdge = edge; // Capture for use in label

                    <g @onclick="@((e) => HandleEdgeClick(edge.Id, e))"
                       @onclick:stopPropagation="true"
                       @ondblclick="@((e) => AddWaypointToEdge(edge.Id, e))"
                       @ondblclick:stopPropagation="true"
                       style="cursor: pointer;">

                        @if (edge.IsDoubleLine)
                        {
                            @* Double line effect *@
                            var offset = strokeWidth + 2;
                            var colorCode = edge.StrokeColor?.Replace("#", "") ?? "374151";

                            @* First line *@
                            <path d="@edge.PathData"
                                  stroke="@strokeColor"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  fill="none"
                                  marker-end="@(edge.ArrowDirection == ArrowDirection.End || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-{colorCode})" : "")"
                                  marker-start="@(edge.ArrowDirection == ArrowDirection.Start || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-start-{colorCode})" : "")"
                                  class="@(isSelected ? "selected-edge" : "")" />

                            @* Second parallel line *@
                            <path d="@GetParallelPath(edge.PathData, offset)"
                                  stroke="@strokeColor"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  fill="none"
                                  class="@(isSelected ? "selected-edge" : "")" />
                        }
                        else
                        {
                            @* Single line *@
                            var colorCode = edge.StrokeColor?.Replace("#", "") ?? "374151";
                            <path d="@edge.PathData"
                                  stroke="@strokeColor"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  fill="none"
                                  marker-end="@(edge.ArrowDirection == ArrowDirection.End || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-{colorCode})" : "")"
                                  marker-start="@(edge.ArrowDirection == ArrowDirection.Start || edge.ArrowDirection == ArrowDirection.Both ? $"url(#arrowhead-start-{colorCode})" : "")"
                                  class="@(isSelected ? "selected-edge" : "")" />
                        }

                        @* Invisible wider path for easier clicking *@
                        <path d="@edge.PathData"
                              stroke="transparent"
                              stroke-width="20"
                              fill="none"
                              style="pointer-events: stroke;" />

                        @* Waypoint handles and midpoint control - drag to move, right-click to delete *@
                        @if (isSelected)
                        {
                            @* Show existing waypoints *@
                            @foreach (var waypoint in edge.Waypoints)
                            {
                                var wp = waypoint; // Capture for lambda
                                <circle cx="@waypoint.X" cy="@waypoint.Y" r="7"
                                        fill="#3b82f6" stroke="white" stroke-width="2"
                                        @onmousedown="@((e) => StartDraggingWaypoint(edge.Id, wp, e))"
                                        @onmousedown:stopPropagation="true"
                                        @oncontextmenu="@((e) => DeleteWaypoint(edge.Id, wp))"
                                        @oncontextmenu:preventDefault="true"
                                        @oncontextmenu:stopPropagation="true"
                                        style="cursor: move;" />
                            }
                            
                            @* Show midpoint handle if no waypoints exist - for easy edge reshaping *@
                            @if (edge.Waypoints.Count == 0)
                            {
                                var mid = GetEdgeMidpoint(edge);
                                <circle cx="@mid.X" cy="@mid.Y" r="6"
                                        fill="white" stroke="#3b82f6" stroke-width="2"
                                        @ondblclick="@((e) => AddWaypointAtMidpoint(edge.Id))"
                                        @ondblclick:stopPropagation="true"
                                        style="cursor: pointer;"
                                        title="Double-click to add waypoint" />
                            }
                        }

                        @* Edge label *@
                        @if (!string.IsNullOrWhiteSpace(currentEdge.Label))
                        {
                            var midpoint = GetEdgeMidpoint(currentEdge);
                            @RenderEdgeLabel(currentEdge, midpoint)
                        }
                    </g>
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error rendering edge {edge.Id}: {ex.Message}");
                }
            }

            @* Render pending connection line *@
            @if (pendingConnectionNodeId.HasValue && pendingConnectionPoint.HasValue)
            {
                <line x1="@pendingConnectionPoint.Value.X"
                      y1="@pendingConnectionPoint.Value.Y"
                      x2="@currentMousePosition.X"
                      y2="@currentMousePosition.Y"
                      stroke="#3b82f6"
                      stroke-width="2"
                      stroke-dasharray="5,5"
                      style="pointer-events: none;" />
            }

            @* Render multi-connect pending line *@
            @if (multiConnectMode && multiConnectSourceNode.HasValue && multiConnectSourceCoords.HasValue)
            {
                @* Line from source to cursor *@
                <line x1="@multiConnectSourceCoords.Value.X"
                      y1="@multiConnectSourceCoords.Value.Y"
                      x2="@currentMousePosition.X"
                      y2="@currentMousePosition.Y"
                      stroke="#8b5cf6"
                      stroke-width="2"
                      stroke-dasharray="5,5"
                      style="pointer-events: none;" />
                
                @* Highlight the source point *@
                <circle cx="@multiConnectSourceCoords.Value.X"
                        cy="@multiConnectSourceCoords.Value.Y"
                        r="10"
                        fill="#8b5cf6"
                        opacity="0.6"
                        style="pointer-events: none;" />
                <circle cx="@multiConnectSourceCoords.Value.X"
                        cy="@multiConnectSourceCoords.Value.Y"
                        r="6"
                        fill="#8b5cf6"
                        stroke="white"
                        stroke-width="2"
                        style="pointer-events: none;" />
            }

            @* Render all nodes *@
            @foreach (var node in nodes)
            {
                var currentNode = node; // Capture for lambda
                var nodeId = node.Id;
                var isMultiConnectSource = multiConnectMode && multiConnectSourceNode == nodeId;

                <g class="node-group"
                   transform="translate(@currentNode.X, @currentNode.Y)"
                   @onmousedown="@((e) => HandleNodeMouseDown(nodeId, e))"
                   @onmousedown:stopPropagation="true"
                   @onclick="@((e) => { if (mode == EditorMode.Select) HandleNodeClick(nodeId, e); })"
                   @onclick:stopPropagation="true"
                   @ondblclick="@((e) => StartEditingNode(nodeId))"
                   @ondblclick:stopPropagation="true"
                   @onmouseenter="@(() => { if (pendingConnectionNodeId.HasValue && pendingConnectionNodeId.Value != nodeId) { hoveredNodeId = nodeId; StateHasChanged(); } })"
                   @onmouseleave="@(() => { if (hoveredNodeId == nodeId) { hoveredNodeId = null; StateHasChanged(); } })">

                    @* Halo effect for multi-connect source node *@
                    @if (isMultiConnectSource)
                    {
                        <rect x="-8" y="-8"
                              width="@(currentNode.Width + 16)"
                              height="@(currentNode.Height + 16)"
                              fill="none"
                              stroke="#8b5cf6"
                              stroke-width="3"
                              stroke-dasharray="8,4"
                              rx="8"
                              opacity="0.8"
                              style="pointer-events: none;">
                            <animate attributeName="stroke-dashoffset" values="0;24" dur="1s" repeatCount="indefinite" />
                        </rect>
                        <rect x="-4" y="-4"
                              width="@(currentNode.Width + 8)"
                              height="@(currentNode.Height + 8)"
                              fill="#8b5cf6"
                              opacity="0.1"
                              rx="6"
                              style="pointer-events: none;" />
                    }

                    @* Draw the shape based on node type *@
                    @if (!string.IsNullOrEmpty(currentNode.TemplateId) && !string.IsNullOrEmpty(currentNode.TemplateShapeId))
                    {
                        var shapeDescriptor = shapeLibrary?.GetShape(currentNode.TemplateId, currentNode.TemplateShapeId);
                        if (shapeDescriptor != null)
                        {
                            <g style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");">
                                @((MarkupString)shapeDescriptor.Render(currentNode))
                                @if (selectedNodes.Contains(nodeId))
                                {
                                    <rect x="-2" y="-2"
                                          width="@(currentNode.Width + 4)"
                                          height="@(currentNode.Height + 4)"
                                          fill="none"
                                          stroke="#3b82f6"
                                          stroke-width="2"
                                          rx="4"
                                          style="pointer-events: none;" />
                                }
                            </g>
                        }
                    }
                    else if (currentNode.Shape == NodeShape.Rectangle)
                    {
                        var nodeStrokeWidth = currentNode.StrokeWidth ?? 2;
                        var cornerRadius = currentNode.CornerRadius ?? 4;
                        var dashArray = currentNode.StrokeDashArray;
                        <rect x="0" y="0"
                              width="@currentNode.Width"
                              height="@currentNode.Height"
                              fill="@(currentNode.FillColor ?? "white")"
                              stroke="@(nodeStrokeWidth == 0 ? "none" : (selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor))"
                              stroke-width="@(selectedNodes.Contains(nodeId) ? Math.Max(nodeStrokeWidth, 3) : nodeStrokeWidth)"
                              stroke-dasharray="@(dashArray ?? "")"
                              rx="@cornerRadius"
                              style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Ellipse)
                    {
                        var nodeStrokeWidth = currentNode.StrokeWidth ?? 2;
                        var dashArray = currentNode.StrokeDashArray;
                        <ellipse cx="@(currentNode.Width / 2)"
                                 cy="@(currentNode.Height / 2)"
                                 rx="@(currentNode.Width / 2)"
                                 ry="@(currentNode.Height / 2)"
                                 fill="@(currentNode.FillColor ?? "white")"
                                 stroke="@(nodeStrokeWidth == 0 ? "none" : (selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor))"
                                 stroke-width="@(selectedNodes.Contains(nodeId) ? Math.Max(nodeStrokeWidth, 3) : nodeStrokeWidth)"
                                 stroke-dasharray="@(dashArray ?? "")"
                                 style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Diamond)
                    {
                        var nodeStrokeWidth = currentNode.StrokeWidth ?? 2;
                        var dashArray = currentNode.StrokeDashArray;
                        var midX = currentNode.Width / 2;
                        var midY = currentNode.Height / 2;
                        <polygon points="@midX,0 @currentNode.Width,@midY @midX,@currentNode.Height 0,@midY"
                                 fill="@(currentNode.FillColor ?? "white")"
                                 stroke="@(nodeStrokeWidth == 0 ? "none" : (selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor))"
                                 stroke-width="@(selectedNodes.Contains(nodeId) ? Math.Max(nodeStrokeWidth, 3) : nodeStrokeWidth)"
                                 stroke-dasharray="@(dashArray ?? "")"
                                 style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Parallelogram)
                    {
                        var nodeStrokeWidth = currentNode.StrokeWidth ?? 2;
                        var dashArray = currentNode.StrokeDashArray;
                        var skew = 15.0;
                        var points = $"{skew},0 {currentNode.Width},0 {currentNode.Width - skew},{currentNode.Height} 0,{currentNode.Height}";
                        <polygon points="@points"
                                 fill="@(currentNode.FillColor ?? "white")"
                                 stroke="@(nodeStrokeWidth == 0 ? "none" : (selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor))"
                                 stroke-width="@(selectedNodes.Contains(nodeId) ? Math.Max(nodeStrokeWidth, 3) : nodeStrokeWidth)"
                                 stroke-dasharray="@(dashArray ?? "")"
                                 style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");" />
                    }
                    else if (currentNode.Shape == NodeShape.Cylinder)
                    {
                        var nodeStrokeWidth = currentNode.StrokeWidth ?? 2;
                        var dashArray = currentNode.StrokeDashArray;
                        var rx = currentNode.Width / 2;
                        var ellipseRy = 10.0;
                        var cy1 = ellipseRy;
                        var cy2 = currentNode.Height - ellipseRy;

                        <g style="cursor: @(mode == EditorMode.Select ? "move" : "pointer");">
                            @* Draw as a single path for better rendering *@
                            <path d="M 0,@cy1
                                     Q 0,@(cy1 - ellipseRy) @rx,@(cy1 - ellipseRy)
                                     Q @currentNode.Width,@(cy1 - ellipseRy) @currentNode.Width,@cy1
                                     L @currentNode.Width,@cy2
                                     Q @currentNode.Width,@(cy2 + ellipseRy) @rx,@(cy2 + ellipseRy)
                                     Q 0,@(cy2 + ellipseRy) 0,@cy2
                                     Z"
                                  fill="@(currentNode.FillColor ?? "white")"
                                  stroke="@(nodeStrokeWidth == 0 ? "none" : (selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor))"
                                  stroke-width="@(selectedNodes.Contains(nodeId) ? Math.Max(nodeStrokeWidth, 3) : nodeStrokeWidth)"
                                  stroke-dasharray="@(dashArray ?? "")" />
                            @* Top arc visible part *@
                            <path d="M 0,@cy1 Q 0,@(cy1 + ellipseRy / 2) @rx,@(cy1 + ellipseRy / 2) Q @currentNode.Width,@(cy1 + ellipseRy / 2) @currentNode.Width,@cy1"
                                  fill="none"
                                  stroke="@(nodeStrokeWidth == 0 ? "none" : (selectedNodes.Contains(nodeId) ? "#3b82f6" : currentNode.StrokeColor))"
                                  stroke-width="@(selectedNodes.Contains(nodeId) ? Math.Max(nodeStrokeWidth, 3) : nodeStrokeWidth)"
                                  stroke-dasharray="@(dashArray ?? "")" />
                        </g>
                    }

                    @* Node text - render using RenderFragment to avoid Razor <text> conflict *@
                    @(RenderNodeTextWithIcon(currentNode))

                    @* Resize handle if selected *@
                    @* Show connection points if: node is selected, OR node is hovered while drawing a connection *@
                    @{
                        // Show connection points if: node is selected, OR we're connecting and hovering, OR an edge connected to this node is selected
                        var hasSelectedEdge = selectedEdges.Any(edgeId => 
                        {
                            var edge = edges.FirstOrDefault(e => e.Id == edgeId);
                            return edge != null && (edge.From == nodeId || edge.To == nodeId);
                        });
                        var showConnectionPoints = selectedNodes.Contains(nodeId) || 
                                                   (pendingConnectionNodeId.HasValue && hoveredNodeId == nodeId) ||
                                                   hasSelectedEdge;
                    }
                    
                    @if (showConnectionPoints)
                    {
                        @* Connection points (5 per side) - show for selected nodes, hover-during-connection, or when connected edge is selected *@
                        {
                            var sides = new[] { "top", "bottom", "left", "right" };
                            var positions = new[] { -2, -1, 0, 1, 2 };
                            const int spacing = 15; // ConnectionPointSpacing from GeometryService

                            foreach (var side in sides)
                            {
                                foreach (var pos in positions)
                                {
                                    double cpX = 0, cpY = 0;
                                    var offset = pos * spacing;

                                    switch (side)
                                    {
                                        case "top":
                                            cpX = currentNode.Width / 2 + offset;
                                            cpY = 0;
                                            break;
                                        case "bottom":
                                            cpX = currentNode.Width / 2 + offset;
                                            cpY = currentNode.Height;
                                            break;
                                        case "left":
                                            cpX = 0;
                                            cpY = currentNode.Height / 2 + offset;
                                            break;
                                        case "right":
                                            cpX = currentNode.Width;
                                            cpY = currentNode.Height / 2 + offset;
                                            break;
                                    }

                                    var isSourceNode = selectedNodes.Contains(nodeId);
                                    var isHoverTarget = (pendingConnectionNodeId.HasValue && hoveredNodeId == nodeId);
                                    var dotColor = isHoverTarget ? "#f59e0b" : "#10b981"; // Orange for hover target, green for selected
                                    var dotSize = isHoverTarget ? 6 : 5; // Larger for hover target

                                    <circle cx="@cpX"
                                            cy="@cpY"
                                            r="@dotSize"
                                            fill="@dotColor"
                                            stroke="white"
                                            stroke-width="2"
                                            style="cursor: crosshair; opacity: 1;"
                                            @onclick="@((e) => HandleConnectionPointClick(nodeId, side, pos, e))"
                                            @onclick:stopPropagation="true" />
                                }
                            }
                        }
                        
                        @* Resize handle - rendered LAST so it appears on top of connection points *@
                        @if (selectedNodes.Contains(nodeId))
                        {
                            <circle cx="@currentNode.Width"
                                    cy="@currentNode.Height"
                                    r="8"
                                    fill="#3b82f6"
                                    stroke="white"
                                    stroke-width="3"
                                    style="cursor: nwse-resize;"
                                    @onmousedown="@((e) => { resizingNodeId = nodeId; })"
                                    @onmousedown:stopPropagation="true" />
                        }
                    }
                </g>
            }
            
            @* Render EdgeLabel objects from edgeLabels list *@
            @foreach (var label in edgeLabels)
            {
                var labelId = label.Id;
                var isSelected = selectedLabels.Contains(labelId);
                
                <g class="edge-label-group"
                   transform="translate(@label.X, @label.Y)"
                   @onmousedown="@((e) => { if (!editingLabelId.HasValue) { draggingLabelId = labelId; dragOffsetX = e.OffsetX - label.X; dragOffsetY = e.OffsetY - label.Y; } })"
                   @onmousedown:stopPropagation="true"
                   @ondblclick="@((e) => { editingLabelId = labelId; StateHasChanged(); })"
                   @ondblclick:stopPropagation="true"
                   style="cursor: move;">
                    
                    <rect x="0" y="0"
                          width="@label.Width"
                          height="@label.Height"
                          fill="white"
                          stroke="@(isSelected ? "#3b82f6" : "#9ca3af")"
                          stroke-width="@(isSelected ? "2" : "1")"
                          rx="3" />
                    
                    @if (editingLabelId == labelId)
                    {
                        <foreignObject x="0" y="0" width="@label.Width" height="@label.Height">
                            <input @ref="textInputRef"
                                   type="text"
                                   @bind="label.Text"
                                   @bind:event="oninput"
                                   @onblur="@(() => { editingLabelId = null; StateHasChanged(); })"
                                   @onkeydown="@((e) => { if (e.Key == "Enter" || e.Key == "Escape") { editingLabelId = null; StateHasChanged(); } })"
                                   style="width: 100%; height: 100%; border: none; background: transparent; text-align: center; font-size: 12px; padding: 2px;" />
                        </foreignObject>
                    }
                    else
                    {
                        @RenderSvgText(label.Text, label.Width / 2, label.Height / 2, 
                            "middle", "middle", "12", "normal", "#374151")
                    }
                    
                    @* Resize handle if selected *@
                    @if (isSelected)
                    {
                        <circle cx="@label.Width"
                                cy="@label.Height"
                                r="5"
                                fill="#3b82f6"
                                stroke="white"
                                stroke-width="2"
                                style="cursor: nwse-resize;"
                                @onmousedown="@((e) => { resizingLabelId = labelId; })"
                                @onmousedown:stopPropagation="true" />
                    }
                </g>
            }

            @* Selection box - inside SVG so it scales with zoom *@
            @if (isSelecting && selectionStart.HasValue)
            {
                var rect = GetSelectionRectangle();
                // Convert screen coords to canvas coords for SVG
                var svgX = rect.X / zoomLevel;
                var svgY = rect.Y / zoomLevel;
                var svgWidth = rect.Width / zoomLevel;
                var svgHeight = rect.Height / zoomLevel;
                var borderColor = isPrintAreaSelection ? "#10b981" : "#3b82f6";
                var bgColor = isPrintAreaSelection ? "rgba(16, 185, 129, 0.1)" : "rgba(59, 130, 246, 0.1)";
                <rect x="@svgX" y="@svgY" width="@svgWidth" height="@svgHeight"
                      fill="@bgColor" stroke="@borderColor" stroke-width="@(2/zoomLevel)"
                      stroke-dasharray="@(5/zoomLevel)" pointer-events="none" />
            }

            @* 1:N Area selection box *@
            @if (isOneToNAreaSelecting && oneToNAreaStart.HasValue)
            {
                var rect = GetOneToNAreaRectangle();
                var svgX = rect.X / zoomLevel;
                var svgY = rect.Y / zoomLevel;
                var svgWidth = rect.Width / zoomLevel;
                var svgHeight = rect.Height / zoomLevel;
                <rect x="@svgX" y="@svgY" width="@svgWidth" height="@svgHeight"
                      fill="rgba(139, 92, 246, 0.1)" stroke="#8b5cf6" stroke-width="@(2/zoomLevel)"
                      stroke-dasharray="@(5/zoomLevel)" pointer-events="none" />
            }
        </svg>

        @* Print area preview (when set) - convert stored screen coords to display *@
        @if (printArea.HasValue && !isSelecting)
        {
            <div style="position: absolute;
                            left: @(printArea.Value.X)px;
                            top: @(printArea.Value.Y)px;
                            width: @(printArea.Value.Width)px;
                            height: @(printArea.Value.Height)px;
                            border: 2px solid #10b981;
                            background-color: rgba(16, 185, 129, 0.05);
                            pointer-events: none;">
                <div style="position: absolute; top: -25px; left: 0; background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">
                    Print Area
                </div>
            </div>
        }
    </div>

<div class="side-panel right-panel @(isRightPanelCollapsed ? "collapsed" : "")">
            <button class="panel-collapse-toggle" @onclick="@(() => isRightPanelCollapsed = !isRightPanelCollapsed)" title="@(isRightPanelCollapsed ? "Expand panel" : "Collapse panel")">
                @(isRightPanelCollapsed ? "◀" : "▶")
            </button>
            @if (!isRightPanelCollapsed)
            {
            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseMinimap = !collapseMinimap)">
                    <span>🗺️ Minimap</span>
                    <span class="collapse-icon">@(collapseMinimap ? "▶" : "▼")</span>
                </button>
                @if (!collapseMinimap)
                {
                    <div class="section-content">
                        <div class="minimap-container" @onclick="HandleMinimapClick" style="cursor: crosshair;">
                            <svg class="minimap" viewBox="0 0 4000 4000" preserveAspectRatio="xMidYMid meet" @ref="minimapRef">
                                <rect x="0" y="0" width="4000" height="4000" fill="#f8fafc" stroke="#e2e8f0" />
                                @foreach (var node in nodes)
                                {
                                    <rect x="@node.X" y="@node.Y" 
                                          width="@node.Width" height="@node.Height"
                                          fill="white" stroke="@node.StrokeColor" stroke-width="8" />
                                }
                                @foreach (var edge in edges)
                                {
                                    <path d="@edge.PathData" 
                                          stroke="@(edge.StrokeColor ?? "#374151")" 
                                          stroke-width="6" fill="none" />
                                }
                                @* Viewport indicator *@
                                <rect x="@scrollX" y="@scrollY" 
                                      width="@viewportWidth" height="@viewportHeight"
                                      fill="rgba(59, 130, 246, 0.1)" 
                                      stroke="#3b82f6" stroke-width="20" 
                                      style="cursor: move;" />
                            </svg>
                        </div>
                    </div>
                }
            </div>

            <div class="panel-section">
                <button class="section-header" @onclick="@(() => collapseInfo = !collapseInfo)">
                    <span>ℹ️ Info</span>
                    <span class="collapse-icon">@(collapseInfo ? "▶" : "▼")</span>
                </button>
                @if (!collapseInfo)
                {
                    <div class="section-content">
                        <div class="property-group">
                            <label>Statistics</label>
                            <div class="stat-row">
                                <span>Nodes:</span>
                                <span>@nodes.Count</span>
                            </div>
                            <div class="stat-row">
                                <span>Edges:</span>
                                <span>@edges.Count</span>
                            </div>
                            <div class="stat-row">
                                <span>Labels:</span>
                                <span>@edgeLabels.Count</span>
                            </div>
                        </div>
                        <div class="property-group">
                            <label>Canvas</label>
                            <div class="stat-row">
                                <span>Size:</span>
                                <span>4000x4000</span>
                            </div>
                            <div class="stat-row">
                                <span>Background:</span>
                                <span>@canvasBackground</span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @* Node Properties - show when exactly one node is selected *@
            @if (selectedNodes.Count == 1)
            {
                var selectedNode = nodes.FirstOrDefault(n => n.Id == selectedNodes.First());
                if (selectedNode != null)
                {
                    <div class="panel-section">
                        <button class="section-header" @onclick="@(() => collapseNodeProperties = !collapseNodeProperties)">
                            <span>📦 Node</span>
                            <span class="collapse-icon">@(collapseNodeProperties ? "▶" : "▼")</span>
                        </button>
                        @if (!collapseNodeProperties)
                        {
                            <div class="section-content">
                                <div class="property-group">
                                    <div class="property-row">
                                        <span>Text:</span>
                                    </div>
                                    <textarea class="property-textarea"
                                              value="@selectedNode.Text"
                                              @onchange="@((e) => UpdateNodeText(selectedNode.Id, e.Value?.ToString() ?? ""))"
                                              placeholder="Enter node text..."
                                              rows="3"></textarea>
                                    <div class="stat-row">
                                        <span>Position:</span>
                                        <span>@((int)selectedNode.X), @((int)selectedNode.Y)</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>Size:</span>
                                        <span>@((int)selectedNode.Width) × @((int)selectedNode.Height)</span>
                                    </div>
                                    <div class="stat-row">
                                        <span>Shape:</span>
                                        <span>@selectedNode.Shape</span>
                                    </div>
                                    @if (selectedNode.TemplateId == "circuit" && !string.IsNullOrEmpty(selectedNode.ComponentLabel))
                                    {
                                        <div class="stat-row">
                                            <span>Component:</span>
                                            <span>@selectedNode.ComponentLabel</span>
                                        </div>
                                        <div class="property-row" style="margin-top: 8px;">
                                            <span>Value:</span>
                                        </div>
                                        <input type="text" class="panel-input"
                                               value="@selectedNode.ComponentValue"
                                               @onchange="@((e) => { selectedNode.ComponentValue = e.Value?.ToString(); StateHasChanged(); })"
                                               placeholder="e.g., 10kΩ, 100µF, 5V" />
                                    }
                                </div>
                                <div class="icon-picker-section">
                                    <label>Icon</label>
                                    <div class="icon-picker">
                                        <button class="icon-btn @(string.IsNullOrEmpty(selectedNode.Icon) ? "selected" : "")"
                                                @onclick="@(() => { selectedNode.Icon = null; StateHasChanged(); })"
                                                title="No icon">
                                            <span style="color: #9ca3af; font-size: 14px;">✕</span>
                                        </button>
                                        @foreach (var category in IconCategories)
                                        {
                                            @foreach (var iconName in category.Value)
                                            {
                                                if (IconLibrary.TryGetValue(iconName, out var iconData))
                                                {
                                                    <button class="icon-btn @(selectedNode.Icon == iconName ? "selected" : "")"
                                                            @onclick="@(() => { selectedNode.Icon = iconName; StateHasChanged(); })"
                                                            title="@iconName">
                                                        <svg width="18" height="18" viewBox="@iconData.ViewBox">
                                                            <path d="@iconData.Path" fill="@(selectedNode.Icon == iconName ? "#3b82f6" : "#374151")"/>
                                                        </svg>
                                                    </button>
                                                }
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="attachment-section">
                                    <label>Attachments</label>
                                    <div class="attachment-upload">
                                        <InputFile OnChange="HandleAttachmentUpload" accept=".svg,.pdf,.gif,.jpg,.jpeg,.png,.webp" />
                                    </div>
                                    @if (selectedNode.Attachments?.Any() == true)
                                    {
                                        <div class="attachment-list">
                                            @foreach (var att in selectedNode.Attachments)
                                            {
                                                <div class="attachment-item">
                                                    <span class="attachment-icon">@(att.FileType == AttachmentType.Svg ? "🖼️" : (att.FileType == AttachmentType.Pdf ? "📄" : "🖼️"))</span>
                                                    <span class="attachment-name" title="@att.FileName">@TruncateFileName(att.FileName, 12)</span>
                                                    @if (att.FileType == AttachmentType.Pdf)
                                                    {
                                                        <button class="attachment-view" @onclick="@(() => OpenPdfAttachment(att))" title="View PDF">👁️</button>
                                                    }
                                                    <button class="attachment-delete" @onclick="@(() => RemoveAttachment(selectedNode, att.Id))" title="Remove">✕</button>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="attachment-empty">No attachments</div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else if (selectedNodes.Count > 1)
            {
                <div class="property-group">
                    <label>Selection</label>
                    <div class="stat-row">
                        <span>Nodes:</span>
                        <span>@selectedNodes.Count</span>
                    </div>
                </div>
            }

            @* Edge Label Properties - show when exactly one label is selected *@
            @if (selectedLabels.Count == 1)
            {
                var selectedLabel = edgeLabels.FirstOrDefault(l => l.Id == selectedLabels.First());
                if (selectedLabel != null)
                {
                    <div class="property-group">
                        <label>Label Properties</label>
                        <div class="property-row">
                            <span>Text:</span>
                        </div>
                        <textarea class="property-textarea"
                                  value="@selectedLabel.Text"
                                  @onchange="@((e) => UpdateLabelText(selectedLabel.Id, e.Value?.ToString() ?? ""))"
                                  placeholder="Enter label text..."
                                  rows="2"></textarea>
                        <div class="stat-row">
                            <span>Position:</span>
                            <span>@((int)selectedLabel.X), @((int)selectedLabel.Y)</span>
                        </div>
                    </div>
                }
            }

            @* Edge Properties - show when edges are selected *@
            @if (selectedEdges.Count > 0)
            {
                <div class="property-group">
                    <label>Edge Selection</label>
                    <div class="stat-row">
                        <span>Edges:</span>
                        <span>@selectedEdges.Count</span>
                    </div>
                    <button class="btn-small" @onclick="@(() => showEdgeStylePanel = !showEdgeStylePanel)">
                        ✏️ Edit Style
                    </button>
                </div>
            }
            }
        </div>
    </div>

    @* Edge Style Panel *@
    @if (showEdgeStylePanel && selectedEdges.Count > 0)
    {
        <div class="edge-style-panel">
            <h3>Edit Edge Style (@selectedEdges.Count selected)</h3>

            @* Connector Style Dropdown - Updates immediately *@
            <div class="panel-row">
                <label>Connector Style:</label>
                <select value="@editEdgeStyle" @onchange="OnEdgeStyleChanged" class="edge-dropdown">
                    <option value="@EdgeStyle.Direct">Direct (Straight)</option>
                    <option value="@EdgeStyle.Ortho">Orthogonal (Right Angles)</option>
                    <option value="@EdgeStyle.OrthoRound">Ortho Rounded</option>
                    <option value="@EdgeStyle.Bezier">Bezier (Smooth Curve)</option>
                    <option value="@EdgeStyle.Arc">Arc (Single Curve)</option>
                    <option value="@EdgeStyle.Stylized">Stylized (Fancy)</option>
                </select>
            </div>

            @* Visual preview of connector styles *@
            <div class="connector-preview">
                <svg viewBox="0 0 280 40" style="width:100%;height:40px;">
                    @if (editEdgeStyle == EdgeStyle.Direct)
                    {
                        <circle cx="20" cy="20" r="6" fill="#3b82f6"/>
                        <line x1="26" y1="20" x2="254" y2="20" stroke="#374151" stroke-width="2"/>
                        <circle cx="260" cy="20" r="6" fill="#3b82f6"/>
                        <polygon points="250,15 260,20 250,25" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Ortho)
                    {
                        <circle cx="20" cy="10" r="6" fill="#3b82f6"/>
                        <path d="M26 10 H140 V30 H254" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="30" r="6" fill="#3b82f6"/>
                        <polygon points="250,25 260,30 250,35" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.OrthoRound)
                    {
                        <circle cx="20" cy="10" r="6" fill="#3b82f6"/>
                        <path d="M26 10 H130 Q140 10 140 20 V20 Q140 30 150 30 H254" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="30" r="6" fill="#3b82f6"/>
                        <polygon points="250,25 260,30 250,35" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Bezier)
                    {
                        <circle cx="20" cy="10" r="6" fill="#3b82f6"/>
                        <path d="M26 10 C80 10, 200 30, 254 30" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="30" r="6" fill="#3b82f6"/>
                        <polygon points="250,25 260,30 250,35" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Arc)
                    {
                        <circle cx="20" cy="20" r="6" fill="#3b82f6"/>
                        <path d="M26 20 A120 40 0 0 1 254 20" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="20" r="6" fill="#3b82f6"/>
                        <polygon points="250,15 260,20 250,25" fill="#374151"/>
                    }
                    else if (editEdgeStyle == EdgeStyle.Stylized)
                    {
                        <circle cx="20" cy="12" r="6" fill="#3b82f6"/>
                        <path d="M26 12 Q35 7 38 17 C70 5, 220 35, 254 28" stroke="#374151" stroke-width="2" fill="none"/>
                        <circle cx="260" cy="28" r="6" fill="#3b82f6"/>
                        <polygon points="250,23 260,28 250,33" fill="#374151"/>
                    }
                </svg>
            </div>

            <div class="panel-row">
                <label>Line Width:</label>
                <select value="@editStrokeWidth" @onchange="@(e => { editStrokeWidth = int.Parse(e.Value?.ToString() ?? "2"); OnEdgePropertyChanged(); })" class="edge-dropdown">
                    <option value="1">1px</option>
                    <option value="2">2px</option>
                    <option value="3">3px</option>
                    <option value="4">4px</option>
                    <option value="5">5px</option>
                </select>
            </div>

            <div class="panel-row">
                <label>Line Style:</label>
                <select value="@editStrokeDashArray" @onchange="@(e => { editStrokeDashArray = e.Value?.ToString() ?? ""; OnEdgePropertyChanged(); })" class="edge-dropdown">
                    @foreach (var style in lineStyles)
                    {
                        <option value="@style.Key">@style.Value</option>
                    }
                </select>
            </div>

            <div class="panel-row">
                <label>Color:</label>
                <div class="color-picker">
                    @foreach (var color in presetColors)
                    {
                        <button class="color-swatch @(editStrokeColor == color ? "selected" : "")"
                                style="background-color: @color;"
                                @onclick="@(() => { editStrokeColor = color; OnEdgePropertyChanged(); })">
                        </button>
                    }
                </div>
            </div>

            <div class="panel-row">
                <label class="checkbox-label">
                    <input type="checkbox" checked="@editIsDoubleLine" 
                           @onchange="@(e => { editIsDoubleLine = (bool)(e.Value ?? false); OnEdgePropertyChanged(); })" />
                    Double Line
                </label>
            </div>

            <div class="panel-row">
                <label>Arrow:</label>
                <select value="@editArrowDirection" @onchange="@(e => { editArrowDirection = Enum.Parse<ArrowDirection>(e.Value?.ToString() ?? "End"); OnEdgePropertyChanged(); })" class="edge-dropdown">
                    <option value="@ArrowDirection.End">→ End Only</option>
                    <option value="@ArrowDirection.Start">← Start Only</option>
                    <option value="@ArrowDirection.Both">↔ Both Ends</option>
                    <option value="@ArrowDirection.None">— No Arrow</option>
                </select>
            </div>

            <div class="panel-buttons">
                <button @onclick="ApplyEdgeStylesToSelected" class="btn-apply">
                    Apply to Selected
                </button>
                <button @onclick="ApplyEdgeStylesToAll" class="btn-apply-all">
                    Apply to All Edges
                </button>
                <button @onclick="@(() => showEdgeStylePanel = false)" class="btn-cancel">
                    Close
                </button>
            </div>
        </div>
    }

    @* Background Configuration Dialog *@
    @if (showBackgroundConfig)
    {
        <div class="dialog-overlay" @onclick="@(() => showBackgroundConfig = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>Configure Background</h2>

                @if (canvasBackground == "swimlanes-h" || canvasBackground == "swimlanes-v")
                {
                    <div class="config-section">
                        <label>Number of Swimlanes:</label>
                        <select @bind="swimlaneCount" class="config-dropdown">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>

                    <div class="config-section">
                        <label>Swimlane Labels:</label>
                        @for (int i = 0; i < swimlaneCount; i++)
                        {
                            var index = i;
                            <input type="text"
                                   value="@(swimlaneLabels.Count > index ? swimlaneLabels[index] : $"Lane {index + 1}")"
                                   @onchange="@((e) => UpdateSwimlaneLabel(index, e.Value?.ToString() ?? ""))"
                                   class="label-input"
                                   placeholder="@($"Lane {index + 1}")" />
                        }
                    </div>
                }
                else if (canvasBackground == "columns")
                {
                    <div class="config-section">
                        <label>Number of Columns:</label>
                        <select @bind="columnCount" class="config-dropdown">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>

                    <div class="config-section">
                        <label>Column Labels:</label>
                        @for (int i = 0; i < columnCount; i++)
                        {
                            var index = i;
                            <input type="text"
                                   value="@(columnLabels.Count > index ? columnLabels[index] : $"Column {index + 1}")"
                                   @onchange="@((e) => UpdateColumnLabel(index, e.Value?.ToString() ?? ""))"
                                   class="label-input"
                                   placeholder="@($"Column {index + 1}")" />
                        }
                    </div>
                }

                <div class="dialog-buttons">
                    <button @onclick="@(() => showBackgroundConfig = false)" class="btn-close">
                        Close
                    </button>
                </div>
            </div>
        </div>
    }

    @* About Dialog *@
    @if (showAboutDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showAboutDialog = false)">
            <div class="dialog" @onclick:stopPropagation="true" style="max-width: 400px;">
                <h2>About DFD Editor</h2>
                <div style="padding: 1rem 0; line-height: 1.8;">
                    <p><strong>DFD Editor v2</strong></p>
                    <p>A visual editor for Data Flow Diagrams</p>
                    <br />
                    <p><strong>Built by:</strong></p>
                    <p>Manbir Sodhi</p>
                    <p><a href="mailto:sodhi@uri.edu" style="color: #3b82f6;">sodhi@uri.edu</a></p>
                    <p>University of Rhode Island</p>
                    <br />
                    <p style="color: #6b7280; font-size: 0.875rem;">Built with Blazor WebAssembly</p>
                </div>
                <div class="dialog-buttons">
                    <button class="btn-primary" @onclick="@(() => showAboutDialog = false)">Close</button>
                </div>
            </div>
        </div>
    }

    @* Load Dialog *@
    @if (showLoadDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showLoadDialog = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>Import Diagram</h2>
                <p>Paste your diagram below. Supports: JSON, Mermaid, DOT (GraphViz)</p>
                
                <div style="margin-bottom: 10px;">
                    <label>Format:</label>
                    <select @bind="importFormat" style="margin-left: 10px; padding: 5px;">
                        <option value="auto">Auto-detect</option>
                        <option value="json">JSON</option>
                        <option value="mermaid">Mermaid</option>
                        <option value="dot">DOT (GraphViz)</option>
                    </select>
                </div>
                
                <textarea class="dialog-textarea" @bind="loadDiagramJson" 
                          placeholder="Paste JSON, Mermaid, or DOT diagram here..."></textarea>
                @if (!string.IsNullOrEmpty(loadErrorMessage))
                {
                    <div class="error-message">@loadErrorMessage</div>
                }
                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="LoadDiagram">Import</button>
                    <button class="btn-secondary" @onclick="@(() => { showLoadDialog = false; loadDiagramJson = ""; loadErrorMessage = ""; })">Cancel</button>
                </div>
            </div>
        </div>
    }

    @* Export Dialog *@
    @if (showExportDialog)
    {
        <div class="dialog-overlay" @onclick="@(() => showExportDialog = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>@exportDialogTitle</h2>
                <p>@exportDialogDescription</p>
                <textarea readonly class="dialog-textarea">@exportedContent</textarea>
                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="CopyToClipboard">Copy to Clipboard</button>
                    <button class="btn-secondary" @onclick="@(() => showExportDialog = false)">Close</button>
                </div>
            </div>
        </div>
    }

    @* Clear Confirmation Dialog *@
    @if (showClearConfirm)
    {
        <div class="dialog-overlay" @onclick="@(() => showClearConfirm = false)">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h2>Clear All?</h2>
                <p>This will delete all nodes, edges, and labels. This action cannot be undone (unless you use Undo immediately after).</p>
                <div class="dialog-actions">
                    <button class="btn-primary" style="background: #ef4444;" @onclick="ConfirmClear">Yes, Clear All</button>
                    <button class="btn-secondary" @onclick="@(() => showClearConfirm = false)">Cancel</button>
                </div>
            </div>
        </div>
    }

    @* Text Edit Dialog - Enhanced with Node Style Options *@
    @if (showTextEditDialog)
    {
        <div class="dialog-overlay" @onclick="CancelTextEdit">
            <div class="dialog-content text-edit-dialog" @onclick:stopPropagation="true" style="min-width: 400px;">
                <h2>@(editingTextNodeId.HasValue ? "Edit Node" : "Edit Label Text")</h2>
                
                @if (editingTextNodeId.HasValue)
                {
                    var editNode = nodes.FirstOrDefault(n => n.Id == editingTextNodeId.Value);
                    @if (editNode != null)
                    {
                        @* Text Section *@
                        <div class="panel-row">
                            <label>Text:</label>
                            <textarea @bind="editingText" 
                                      @bind:event="oninput"
                                      @onkeydown="HandleTextEditKeyDown"
                                      @ref="textEditTextarea"
                                      class="text-edit-textarea"
                                      placeholder="Enter text here..."
                                      rows="3"></textarea>
                        </div>

                        @* Shape Dropdown *@
                        <div class="panel-row">
                            <label>Shape:</label>
                            <select value="@editNode.Shape" @onchange="@(e => { if (Enum.TryParse<NodeShape>(e.Value?.ToString(), out var s)) editNode.Shape = s; StateHasChanged(); })" class="edge-dropdown" style="width:100%;">
                                <option value="@NodeShape.Rectangle">Rectangle</option>
                                <option value="@NodeShape.Ellipse">Ellipse</option>
                                <option value="@NodeShape.Diamond">Diamond</option>
                                <option value="@NodeShape.Parallelogram">Parallelogram</option>
                                <option value="@NodeShape.Cylinder">Cylinder</option>
                            </select>
                        </div>

                        @* Size *@
                        <div class="panel-row">
                            <label>Size:</label>
                            <div class="size-inputs">
                                <span>W:</span>
                                <input type="number" value="@((int)editNode.Width)" 
                                       @onchange="@(e => { editNode.Width = double.Parse(e.Value?.ToString() ?? "120"); RecalculateEdgePaths(editNode.Id); })" 
                                       class="size-input" min="40" />
                                <span>H:</span>
                                <input type="number" value="@((int)editNode.Height)" 
                                       @onchange="@(e => { editNode.Height = double.Parse(e.Value?.ToString() ?? "60"); RecalculateEdgePaths(editNode.Id); })" 
                                       class="size-input" min="30" />
                            </div>
                        </div>

                        @* Fill Color *@
                        <div class="panel-row">
                            <label>Fill Color:</label>
                            <div class="color-picker">
                                @foreach (var color in nodeFillColors)
                                {
                                    <button class="color-swatch @(editNode.FillColor == color ? "selected" : "")"
                                            style="background-color: @color;"
                                            @onclick="@(() => { editNode.FillColor = color; StateHasChanged(); })">
                                    </button>
                                }
                            </div>
                        </div>

                        @* Border Color *@
                        <div class="panel-row">
                            <label>Border Color:</label>
                            <div class="color-picker">
                                @foreach (var color in presetColors)
                                {
                                    <button class="color-swatch @(editNode.StrokeColor == color ? "selected" : "")"
                                            style="background-color: @color;"
                                            @onclick="@(() => { editNode.StrokeColor = color; StateHasChanged(); })">
                                    </button>
                                }
                            </div>
                        </div>

                        @* Border Width *@
                        <div class="panel-row">
                            <label>Border Width:</label>
                            <select value="@(editNode.StrokeWidth ?? 2)" @onchange="@(e => { editNode.StrokeWidth = int.Parse(e.Value?.ToString() ?? "2"); StateHasChanged(); })" class="edge-dropdown" style="width:100%;">
                                <option value="0">None</option>
                                <option value="1">1px</option>
                                <option value="2">2px</option>
                                <option value="3">3px</option>
                                <option value="4">4px</option>
                                <option value="5">5px</option>
                            </select>
                        </div>

                        @* Border Style *@
                        <div class="panel-row">
                            <label>Border Style:</label>
                            <select value="@(editNode.StrokeDashArray ?? "")" @onchange="@(e => { editNode.StrokeDashArray = string.IsNullOrEmpty(e.Value?.ToString()) ? null : e.Value?.ToString(); StateHasChanged(); })" class="edge-dropdown" style="width:100%;">
                                <option value="">Solid</option>
                                <option value="5,5">Dashed</option>
                                <option value="2,2">Dotted</option>
                                <option value="10,5,2,5">Dash-Dot</option>
                            </select>
                        </div>

                        @* Corner Radius (only for Rectangle) *@
                        @if (editNode.Shape == NodeShape.Rectangle)
                        {
                            <div class="panel-row">
                                <label>Corner Radius:</label>
                                <select value="@(editNode.CornerRadius ?? 4)" @onchange="@(e => { editNode.CornerRadius = int.Parse(e.Value?.ToString() ?? "4"); StateHasChanged(); })" class="edge-dropdown" style="width:100%;">
                                    <option value="0">None (Square)</option>
                                    <option value="4">Small (4px)</option>
                                    <option value="8">Medium (8px)</option>
                                    <option value="12">Large (12px)</option>
                                    <option value="20">Round (20px)</option>
                                </select>
                            </div>
                        }

                        @* Attachments *@
                        <div class="panel-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <label>Attachments:</label>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <InputFile OnChange="@(e => HandleDialogAttachmentUpload(e, editNode))" accept=".svg,.pdf,.gif,.jpg,.jpeg,.png,.webp" />
                        </div>
                        @if (editNode.Attachments?.Any() == true)
                        {
                            <div style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 8px;">
                                @foreach (var att in editNode.Attachments)
                                {
                                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 11px;">
                                        <span>@(att.FileType == AttachmentType.Pdf ? "📄" : "🖼️")</span>
                                        <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@att.FileName">@TruncateFileName(att.FileName, 20)</span>
                                        @if (att.FileType == AttachmentType.Svg || att.FileType == AttachmentType.Image)
                                        {
                                            <button type="button" style="padding: 2px 6px; font-size: 10px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 3px; cursor: pointer;"
                                                    @onclick="@(() => PlaceAttachmentOnCanvas(editNode, att))" title="Place on canvas">📍</button>
                                        }
                                        @if (att.FileType == AttachmentType.Pdf)
                                        {
                                            <button type="button" style="padding: 2px 6px; font-size: 10px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 3px; cursor: pointer;"
                                                    @onclick="@(() => OpenPdfAttachment(att))" title="View PDF">👁️</button>
                                        }
                                        <button type="button" style="padding: 2px 6px; font-size: 10px; background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; border-radius: 3px; cursor: pointer;"
                                                @onclick="@(() => RemoveAttachment(editNode, att.Id))" title="Remove">✕</button>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div style="font-size: 11px; color: #9ca3af; text-align: center; padding: 8px;">No attachments</div>
                        }
                    }
                }
                else
                {
                    @* Label-only editing (original behavior) *@
                    <p style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        Press Enter for new line. Press Escape or click outside to cancel.
                    </p>
                    <textarea @bind="editingText" 
                              @bind:event="oninput"
                              @onkeydown="HandleTextEditKeyDown"
                              @ref="textEditTextarea"
                              class="text-edit-textarea"
                              placeholder="Enter text here..."
                              rows="5"></textarea>
                }
                
                <div class="dialog-actions">
                    <button class="btn-primary" @onclick="SaveTextEdit">💾 Save</button>
                    <button class="btn-secondary" @onclick="CancelTextEdit">Cancel</button>
                </div>
            </div>
        </div>
    }

    @* ===== HELP MODAL ===== *@
    @if (showHelpModal)
    {
        <div class="dialog-overlay" @onclick="CloseHelp">
            <div class="help-modal" @onclick:stopPropagation="true">
                <div class="help-header">
                    <h2>📖 DFD Editor Help</h2>
                    <button class="modal-close-btn" @onclick="CloseHelp">✕</button>
                </div>
                
                <div class="help-body">
                    <nav class="help-nav">
                        @foreach (var section in HelpSections)
                        {
                            <button class="help-nav-btn @(activeHelpSection == section.Key ? "active" : "")"
                                    @onclick="@(() => SetHelpSection(section.Key))">
                                <span>@(section.Value.Icon)</span> @(section.Value.Title)
                            </button>
                        }
                    </nav>
                    
                    <div class="help-content">
                        @if (activeHelpSection == "getting-started")
                        {
                            <h3>🚀 Getting Started</h3>
                            <p>Welcome to the DFD Editor! Create professional diagrams in minutes.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 120" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Step 1: Add Node -->
                                    <rect x="10" y="30" width="80" height="50" rx="4" fill="#eff6ff" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="50" y="60" text-anchor="middle" font-size="11" fill="#1e40af">Add Node</text>
                                    <text x="50" y="100" text-anchor="middle" font-size="9" fill="#6b7280">1. Click toolbar</text>
                                    
                                    <!-- Arrow -->
                                    <path d="M100 55 L130 55" stroke="#9ca3af" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    
                                    <!-- Step 2: Click Canvas -->
                                    <rect x="140" y="20" width="100" height="70" rx="4" fill="#f8fafc" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4"/>
                                    <rect x="165" y="40" width="50" height="30" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="190" y="60" text-anchor="middle" font-size="10" fill="#1e40af">Node</text>
                                    <text x="190" y="108" text-anchor="middle" font-size="9" fill="#6b7280">2. Click canvas</text>
                                    
                                    <!-- Arrow -->
                                    <path d="M250 55 L280 55" stroke="#9ca3af" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    
                                    <!-- Step 3: Connect -->
                                    <rect x="290" y="35" width="45" height="25" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <circle cx="335" cy="47" r="4" fill="#3b82f6"/>
                                    <path d="M339 47 L371 47" stroke="#3b82f6" stroke-width="2"/>
                                    <circle cx="375" cy="47" r="4" fill="#3b82f6"/>
                                    <rect x="379" y="35" width="45" height="25" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="357" y="108" text-anchor="middle" font-size="9" fill="#6b7280">3. Connect nodes</text>
                                    
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>Quick Start Steps</h4>
                            <ol>
                                <li><b>Add a node:</b> Click "Add Shape" in toolbar, then click on canvas</li>
                                <li><b>Edit text:</b> Double-click any node to edit its label</li>
                                <li><b>Connect nodes:</b> Click connection point (○) on one node, then on another</li>
                                <li><b>Move nodes:</b> Click and drag any node</li>
                                <li><b>Change properties:</b> Select node, use right panel to change shape, color, icon</li>
                            </ol>
                            
                            <div class="help-tip">
                                <b>💡 Tip:</b> Load an example from the <b>Examples</b> menu to see how diagrams are built!
                            </div>
                        }
                        else if (activeHelpSection == "shapes")
                        {
                            <h3>⬡ Shapes & Meanings</h3>
                            <p>Each shape has a specific meaning. Using correct shapes helps viewers understand your diagram instantly.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 520 200" style="width:100%;max-width:520px;height:auto;">
                                    <!-- Rectangle -->
                                    <rect x="10" y="20" width="80" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="50" y="48" text-anchor="middle" font-size="10" fill="#065f46">Entity</text>
                                    <text x="50" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Rectangle</text>
                                    <text x="50" y="95" text-anchor="middle" font-size="8" fill="#6b7280">External entities</text>
                                    <text x="50" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Process steps</text>
                                    
                                    <!-- Ellipse -->
                                    <ellipse cx="155" cy="42" rx="45" ry="25" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="155" y="47" text-anchor="middle" font-size="10" fill="#1e40af">Process</text>
                                    <text x="155" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Ellipse</text>
                                    <text x="155" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Processes (DFD)</text>
                                    <text x="155" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Start/End</text>
                                    
                                    <!-- Diamond -->
                                    <polygon points="260,17 295,42 260,67 225,42" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="260" y="46" text-anchor="middle" font-size="9" fill="#92400e">Yes?</text>
                                    <text x="260" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Diamond</text>
                                    <text x="260" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Decision point</text>
                                    <text x="260" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Yes/No branch</text>
                                    
                                    <!-- Parallelogram -->
                                    <polygon points="330,20 400,20 385,65 315,65" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="357" y="47" text-anchor="middle" font-size="9" fill="#92400e">D1: Data</text>
                                    <text x="357" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Parallelogram</text>
                                    <text x="357" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Data stores</text>
                                    <text x="357" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Input/Output</text>
                                    
                                    <!-- Cylinder -->
                                    <ellipse cx="465" cy="25" rx="35" ry="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <rect x="430" y="25" width="70" height="35" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" stroke-dasharray="0,35,70,35"/>
                                    <ellipse cx="465" cy="60" rx="35" ry="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="465" y="47" text-anchor="middle" font-size="9" fill="#1e40af">DB</text>
                                    <text x="465" y="82" text-anchor="middle" font-size="9" fill="#374151" font-weight="bold">Cylinder</text>
                                    <text x="465" y="95" text-anchor="middle" font-size="8" fill="#6b7280">Databases</text>
                                    <text x="465" y="106" text-anchor="middle" font-size="8" fill="#6b7280">Storage</text>
                                    
                                    <!-- Color Legend -->
                                    <rect x="10" y="130" width="500" height="60" rx="6" fill="#f8fafc" stroke="#e2e8f0"/>
                                    <text x="20" y="150" font-size="10" fill="#374151" font-weight="bold">Color Conventions:</text>
                                    <rect x="20" y="160" width="12" height="12" fill="#3b82f6"/>
                                    <text x="38" y="170" font-size="9" fill="#475569">Blue: Processes, UI</text>
                                    <rect x="130" y="160" width="12" height="12" fill="#059669"/>
                                    <text x="148" y="170" font-size="9" fill="#475569">Green: Users, entities</text>
                                    <rect x="260" y="160" width="12" height="12" fill="#8b5cf6"/>
                                    <text x="278" y="170" font-size="9" fill="#475569">Purple: External APIs</text>
                                    <rect x="380" y="160" width="12" height="12" fill="#f59e0b"/>
                                    <text x="398" y="170" font-size="9" fill="#475569">Amber: Data stores</text>
                                </svg>
                            </div>
                        }
                        else if (activeHelpSection == "connections")
                        {
                            <h3>↗ Connections & Edges</h3>
                            <p>Edges show data flow or control flow between elements.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 160" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Connection points demo -->
                                    <text x="10" y="15" font-size="10" fill="#374151" font-weight="bold">Connection Points (hover to see):</text>
                                    <rect x="60" y="35" width="100" height="50" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="110" y="65" text-anchor="middle" font-size="10" fill="#1e40af">Node</text>
                                    <!-- Connection points -->
                                    <circle cx="110" cy="35" r="5" fill="#3b82f6"/>
                                    <circle cx="160" cy="60" r="5" fill="#3b82f6"/>
                                    <circle cx="110" cy="85" r="5" fill="#3b82f6"/>
                                    <circle cx="60" cy="60" r="5" fill="#3b82f6"/>
                                    <text x="110" y="105" text-anchor="middle" font-size="8" fill="#6b7280">5 points per side</text>
                                    
                                    <!-- Arrow with label -->
                                    <text x="200" y="15" font-size="10" fill="#374151" font-weight="bold">Labeled Edge:</text>
                                    <rect x="200" y="35" width="60" height="35" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="230" y="57" text-anchor="middle" font-size="9" fill="#065f46">User</text>
                                    <path d="M260 52 L320 52" stroke="#374151" stroke-width="2" marker-end="url(#arr2)"/>
                                    <rect x="275" y="40" width="35" height="16" fill="white" stroke="#e2e8f0"/>
                                    <text x="292" y="52" text-anchor="middle" font-size="8" fill="#374151">Order</text>
                                    <rect x="320" y="35" width="60" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="350" y="57" text-anchor="middle" font-size="9" fill="#1e40af">System</text>
                                    
                                    <!-- Line styles -->
                                    <text x="10" y="130" font-size="10" fill="#374151" font-weight="bold">Edge Styles:</text>
                                    <line x1="90" y1="130" x2="150" y2="130" stroke="#374151" stroke-width="2"/>
                                    <text x="120" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Solid</text>
                                    <line x1="180" y1="130" x2="240" y2="130" stroke="#374151" stroke-width="2" stroke-dasharray="8,4"/>
                                    <text x="210" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Dashed</text>
                                    <line x1="270" y1="130" x2="330" y2="130" stroke="#374151" stroke-width="2" stroke-dasharray="2,4"/>
                                    <text x="300" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Dotted</text>
                                    <line x1="360" y1="127" x2="420" y2="127" stroke="#374151" stroke-width="2"/>
                                    <line x1="360" y1="133" x2="420" y2="133" stroke="#374151" stroke-width="2"/>
                                    <text x="390" y="145" text-anchor="middle" font-size="8" fill="#6b7280">Double</text>
                                    
                                    <defs>
                                        <marker id="arr2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <div class="help-warning">
                                <b>⚠️ Important:</b> Always label your edges! Unlabeled arrows leave viewers guessing what data flows between nodes.
                            </div>
                        }
                        else if (activeHelpSection == "icons")
                        {
                            <h3>🎨 Icons Library</h3>
                            <p>Icons make diagrams more intuitive. They automatically match your node's stroke color.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 100" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Icon examples -->
                                    <rect x="10" y="10" width="70" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <circle cx="45" cy="28" r="8" fill="none" stroke="#059669" stroke-width="1.5"/>
                                    <path d="M37 42 L53 42 Q45 35 37 42" fill="none" stroke="#059669" stroke-width="1.5"/>
                                    <text x="45" y="70" text-anchor="middle" font-size="8" fill="#6b7280">user</text>
                                    
                                    <rect x="95" y="10" width="70" height="45" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <circle cx="130" cy="30" r="10" fill="none" stroke="#3b82f6" stroke-width="1.5"/>
                                    <circle cx="130" cy="30" r="3" fill="#3b82f6"/>
                                    <path d="M123 37 L137 23" stroke="#3b82f6" stroke-width="1.5"/>
                                    <text x="130" y="70" text-anchor="middle" font-size="8" fill="#6b7280">gear</text>
                                    
                                    <rect x="180" y="10" width="70" height="45" rx="4" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
                                    <ellipse cx="215" cy="22" rx="12" ry="6" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
                                    <rect x="203" y="22" width="24" height="18" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
                                    <ellipse cx="215" cy="40" rx="12" ry="6" fill="none" stroke="#8b5cf6" stroke-width="1.5"/>
                                    <text x="215" y="70" text-anchor="middle" font-size="8" fill="#6b7280">database</text>
                                    
                                    <rect x="265" y="10" width="70" height="45" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <path d="M290 20 L300 20 L300 45 L290 45 Z M302 25 L320 25 L320 40 L302 40 Z" fill="none" stroke="#f59e0b" stroke-width="1.5"/>
                                    <text x="300" y="70" text-anchor="middle" font-size="8" fill="#6b7280">file</text>
                                    
                                    <rect x="350" y="10" width="70" height="45" rx="4" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                                    <rect x="365" y="20" width="40" height="25" rx="2" fill="none" stroke="#dc2626" stroke-width="1.5"/>
                                    <path d="M372 27 L385 35 L398 27" fill="none" stroke="#dc2626" stroke-width="1.5"/>
                                    <text x="385" y="70" text-anchor="middle" font-size="8" fill="#6b7280">email</text>
                                    
                                    <rect x="435" y="10" width="55" height="45" rx="4" fill="#f0fdf4" stroke="#059669" stroke-width="2"/>
                                    <path d="M455 20 L472 35 L455 35 L455 45 L448 45 L448 35 L440 35 Z" fill="none" stroke="#059669" stroke-width="1.5"/>
                                    <text x="462" y="70" text-anchor="middle" font-size="8" fill="#6b7280">cloud</text>
                                </svg>
                            </div>
                            
                            <h4>Available Icon Categories</h4>
                            <table class="help-table">
                                <tr><th>Category</th><th>Icons</th></tr>
                                <tr><td>People</td><td>user, users, user-plus, user-check</td></tr>
                                <tr><td>Technology</td><td>computer, mobile, server, database, cloud</td></tr>
                                <tr><td>Files</td><td>file, file-text, folder, document</td></tr>
                                <tr><td>Actions</td><td>gear, check, error, play, stop, refresh</td></tr>
                                <tr><td>Security</td><td>lock, shield, key</td></tr>
                                <tr><td>Commerce</td><td>cart, credit-card</td></tr>
                            </table>
                        }
                        else if (activeHelpSection == "dfd")
                        {
                            <h3>📊 Data Flow Diagrams (DFD)</h3>
                            <p>DFDs show how data moves through a system. They're excellent for system analysis.</p>
                            
                            <h4>Context Diagram Example</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 180" style="width:100%;max-width:500px;height:auto;">
                                    <!-- External Entity: Customer -->
                                    <rect x="20" y="60" width="80" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="60" y="87" text-anchor="middle" font-size="10" fill="#065f46">Customer</text>
                                    
                                    <!-- Central Process -->
                                    <ellipse cx="250" cy="82" rx="70" ry="40" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="250" y="78" text-anchor="middle" font-size="10" fill="#1e40af">Order</text>
                                    <text x="250" y="92" text-anchor="middle" font-size="10" fill="#1e40af">System</text>
                                    
                                    <!-- External Entity: Supplier -->
                                    <rect x="400" y="20" width="80" height="45" rx="4" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="440" y="47" text-anchor="middle" font-size="10" fill="#065f46">Supplier</text>
                                    
                                    <!-- External Entity: Bank -->
                                    <rect x="400" y="100" width="80" height="45" rx="4" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
                                    <text x="440" y="127" text-anchor="middle" font-size="10" fill="#6b21a8">Bank</text>
                                    
                                    <!-- Data Flows -->
                                    <path d="M100 75 L175 75" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="137" y="68" text-anchor="middle" font-size="8" fill="#374151">Orders</text>
                                    
                                    <path d="M320 60 L395 45" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="355" y="45" text-anchor="middle" font-size="8" fill="#374151">PO</text>
                                    
                                    <path d="M320 100 L395 120" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="355" y="118" text-anchor="middle" font-size="8" fill="#374151">Payment</text>
                                    
                                    <!-- Legend -->
                                    <rect x="10" y="150" width="480" height="25" rx="4" fill="#f8fafc"/>
                                    <rect x="20" y="157" width="30" height="12" rx="2" fill="#dcfce7" stroke="#059669"/>
                                    <text x="58" y="167" font-size="8" fill="#475569">External Entity</text>
                                    <ellipse cx="155" cy="163" rx="20" ry="8" fill="#dbeafe" stroke="#3b82f6"/>
                                    <text x="185" y="167" font-size="8" fill="#475569">Process</text>
                                    <path d="M250 163 L290 163" stroke="#374151" stroke-width="1.5" marker-end="url(#arr3)"/>
                                    <text x="320" y="167" font-size="8" fill="#475569">Data Flow</text>
                                    
                                    <defs>
                                        <marker id="arr3" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>DFD Hierarchy</h4>
                            <ul>
                                <li><b>Context Diagram (Level 0):</b> Entire system as ONE process with external entities</li>
                                <li><b>Level 1 DFD:</b> Expand into sub-processes numbered 1.0, 2.0, 3.0...</li>
                                <li><b>Level 2+ DFD:</b> Further detail: 1.1, 1.2, 2.1, 2.2...</li>
                            </ul>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → Context Diagram or Level 0 DFD
                            </div>
                        }
                        else if (activeHelpSection == "flowcharts")
                        {
                            <h3>📋 Flowcharts</h3>
                            <p>Show step-by-step processes with decisions and branches.</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 220" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Start -->
                                    <ellipse cx="100" cy="25" rx="35" ry="18" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="100" y="30" text-anchor="middle" font-size="10" fill="#065f46">Start</text>
                                    
                                    <!-- Arrow down -->
                                    <path d="M100 43 L100 60" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    
                                    <!-- Process -->
                                    <rect x="55" y="65" width="90" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="100" y="87" text-anchor="middle" font-size="10" fill="#1e40af">Process Step</text>
                                    
                                    <!-- Arrow down -->
                                    <path d="M100 100 L100 120" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    
                                    <!-- Decision -->
                                    <polygon points="100,125 145,155 100,185 55,155" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="100" y="159" text-anchor="middle" font-size="10" fill="#92400e">Valid?</text>
                                    
                                    <!-- Yes branch -->
                                    <path d="M100 185 L100 205" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    <text x="108" y="198" font-size="8" fill="#059669">Yes</text>
                                    
                                    <!-- End -->
                                    <ellipse cx="100" cy="220" rx="30" ry="15" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                                    <text x="100" y="224" text-anchor="middle" font-size="9" fill="#dc2626">End</text>
                                    
                                    <!-- No branch -->
                                    <path d="M145 155 L200 155" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    <text x="170" y="148" font-size="8" fill="#dc2626">No</text>
                                    
                                    <!-- Error handling -->
                                    <rect x="205" y="140" width="70" height="30" rx="4" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
                                    <text x="240" y="159" text-anchor="middle" font-size="9" fill="#dc2626">Show Error</text>
                                    
                                    <!-- Loop back -->
                                    <path d="M240 140 L240 82 L150 82" stroke="#374151" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arr4)"/>
                                    
                                    <!-- Legend on right -->
                                    <rect x="320" y="20" width="170" height="180" rx="6" fill="#f8fafc" stroke="#e2e8f0"/>
                                    <text x="330" y="40" font-size="10" fill="#374151" font-weight="bold">Flowchart Symbols</text>
                                    
                                    <ellipse cx="345" cy="60" rx="15" ry="8" fill="#dcfce7" stroke="#059669" stroke-width="1"/>
                                    <text x="370" y="64" font-size="9" fill="#475569">Start / End</text>
                                    
                                    <rect x="330" y="80" width="30" height="16" rx="2" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
                                    <text x="370" y="92" font-size="9" fill="#475569">Process</text>
                                    
                                    <polygon points="345,105 360,118 345,131 330,118" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
                                    <text x="370" y="122" font-size="9" fill="#475569">Decision</text>
                                    
                                    <polygon points="330,145 365,145 360,165 325,165" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
                                    <text x="370" y="158" font-size="9" fill="#475569">Input/Output</text>
                                    
                                    <path d="M330 180 L360 180" stroke="#374151" stroke-width="1.5" marker-end="url(#arr4)"/>
                                    <text x="370" y="184" font-size="9" fill="#475569">Flow</text>
                                    
                                    <defs>
                                        <marker id="arr4" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → Login Flow
                            </div>
                        }
                        else if (activeHelpSection == "swimlanes")
                        {
                            <h3>🏊 Swimlane Diagrams</h3>
                            <p>Organize process flows by <b>who performs each step</b> (roles, departments, or systems).</p>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 520 240" style="width:100%;max-width:520px;height:auto;">
                                    <!-- Lane backgrounds -->
                                    <rect x="80" y="0" width="140" height="240" fill="#eff6ff" stroke="#bfdbfe"/>
                                    <rect x="220" y="0" width="140" height="240" fill="#f0fdf4" stroke="#bbf7d0"/>
                                    <rect x="360" y="0" width="140" height="240" fill="#fef3c7" stroke="#fde68a"/>
                                    
                                    <!-- Lane headers -->
                                    <rect x="80" y="0" width="140" height="30" fill="#3b82f6"/>
                                    <text x="150" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Customer</text>
                                    <rect x="220" y="0" width="140" height="30" fill="#059669"/>
                                    <text x="290" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Sales Team</text>
                                    <rect x="360" y="0" width="140" height="30" fill="#f59e0b"/>
                                    <text x="430" y="20" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Warehouse</text>
                                    
                                    <!-- Row labels -->
                                    <text x="40" y="60" text-anchor="middle" font-size="9" fill="#6b7280">Order</text>
                                    <text x="40" y="120" text-anchor="middle" font-size="9" fill="#6b7280">Process</text>
                                    <text x="40" y="180" text-anchor="middle" font-size="9" fill="#6b7280">Fulfill</text>
                                    
                                    <!-- Customer activities -->
                                    <rect x="105" y="45" width="90" height="30" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="150" y="64" text-anchor="middle" font-size="9" fill="#1e40af">Place Order</text>
                                    
                                    <rect x="105" y="165" width="90" height="30" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="150" y="184" text-anchor="middle" font-size="9" fill="#1e40af">Receive</text>
                                    
                                    <!-- Sales activities -->
                                    <rect x="245" y="45" width="90" height="30" rx="4" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="290" y="64" text-anchor="middle" font-size="9" fill="#065f46">Confirm</text>
                                    
                                    <rect x="245" y="105" width="90" height="30" rx="4" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="290" y="124" text-anchor="middle" font-size="9" fill="#065f46">Invoice</text>
                                    
                                    <!-- Warehouse activities -->
                                    <rect x="385" y="105" width="90" height="30" rx="4" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="430" y="124" text-anchor="middle" font-size="9" fill="#92400e">Pick Items</text>
                                    
                                    <rect x="385" y="165" width="90" height="30" rx="4" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="430" y="184" text-anchor="middle" font-size="9" fill="#92400e">Ship</text>
                                    
                                    <!-- Flow arrows -->
                                    <path d="M195 60 L240 60" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M335 60 L335 120 L380 120" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M430 135 L430 160" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M385 180 L200 180" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    <path d="M290 75 L290 100" stroke="#374151" stroke-width="1.5" marker-end="url(#arr5)"/>
                                    
                                    <!-- Labels on arrows -->
                                    <rect x="200" y="50" width="35" height="14" fill="white"/>
                                    <text x="217" y="61" text-anchor="middle" font-size="7" fill="#6b7280">Order</text>
                                    <rect x="280" y="170" width="40" height="14" fill="white"/>
                                    <text x="300" y="181" text-anchor="middle" font-size="7" fill="#6b7280">Package</text>
                                    
                                    <!-- Tip box -->
                                    <rect x="10" y="210" width="500" height="25" rx="4" fill="#fef3c7" stroke="#f59e0b"/>
                                    <text x="260" y="227" text-anchor="middle" font-size="9" fill="#92400e">💡 Use COLOR to identify lanes: Blue=Customer, Green=Staff, Amber=Systems</text>
                                    
                                    <defs>
                                        <marker id="arr5" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>How to Create Swimlanes</h4>
                            <ol>
                                <li><b>Plan lanes:</b> Decide actors (2-4 lanes works best)</li>
                                <li><b>Create headers:</b> Add rectangle nodes at top for each lane name</li>
                                <li><b>Color code:</b> Use same color for all nodes in each lane</li>
                                <li><b>Align vertically:</b> Keep each actor's tasks in their column</li>
                                <li><b>Label handoffs:</b> Name what passes between lanes</li>
                            </ol>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → E-Commerce Flow
                            </div>
                        }
                        else if (activeHelpSection == "architecture")
                        {
                            <h3>🏗 Architecture Diagrams</h3>
                            <p>Show the structure and components of software systems.</p>
                            
                            <h4>3-Tier Architecture</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 500 200" style="width:100%;max-width:500px;height:auto;">
                                    <!-- Presentation Layer -->
                                    <rect x="10" y="10" width="480" height="50" rx="6" fill="#eff6ff" stroke="#bfdbfe"/>
                                    <text x="20" y="28" font-size="9" fill="#1e40af" font-weight="bold">PRESENTATION LAYER</text>
                                    <rect x="80" y="25" width="80" height="28" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="120" y="43" text-anchor="middle" font-size="9" fill="#1e40af">🖥 Web</text>
                                    <rect x="210" y="25" width="80" height="28" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="250" y="43" text-anchor="middle" font-size="9" fill="#1e40af">📱 Mobile</text>
                                    <rect x="340" y="25" width="80" height="28" rx="4" fill="white" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="380" y="43" text-anchor="middle" font-size="9" fill="#1e40af">🔌 API</text>
                                    
                                    <!-- Arrows -->
                                    <path d="M250 60 L250 75" stroke="#374151" stroke-width="2" marker-end="url(#arr6)"/>
                                    
                                    <!-- Business Layer -->
                                    <rect x="10" y="80" width="480" height="50" rx="6" fill="#f0fdf4" stroke="#bbf7d0"/>
                                    <text x="20" y="98" font-size="9" fill="#065f46" font-weight="bold">BUSINESS LOGIC LAYER</text>
                                    <ellipse cx="120" cy="110" rx="45" ry="16" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="120" y="114" text-anchor="middle" font-size="9" fill="#065f46">⚙ Auth</text>
                                    <ellipse cx="250" cy="110" rx="45" ry="16" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="250" y="114" text-anchor="middle" font-size="9" fill="#065f46">⚙ Orders</text>
                                    <ellipse cx="380" cy="110" rx="45" ry="16" fill="white" stroke="#059669" stroke-width="2"/>
                                    <text x="380" y="114" text-anchor="middle" font-size="9" fill="#065f46">⚙ Users</text>
                                    
                                    <!-- Arrows -->
                                    <path d="M250 130 L250 145" stroke="#374151" stroke-width="2" marker-end="url(#arr6)"/>
                                    
                                    <!-- Data Layer -->
                                    <rect x="10" y="150" width="480" height="45" rx="6" fill="#fef3c7" stroke="#fde68a"/>
                                    <text x="20" y="168" font-size="9" fill="#92400e" font-weight="bold">DATA LAYER</text>
                                    
                                    <!-- Database cylinders -->
                                    <ellipse cx="150" cy="165" rx="30" ry="6" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <path d="M120 165 L120 182 Q150 195 180 182 L180 165" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <ellipse cx="150" cy="182" rx="30" ry="6" fill="none" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="150" y="200" text-anchor="middle" font-size="8" fill="#92400e">Users DB</text>
                                    
                                    <ellipse cx="350" cy="165" rx="30" ry="6" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <path d="M320 165 L320 182 Q350 195 380 182 L380 165" fill="white" stroke="#f59e0b" stroke-width="2"/>
                                    <ellipse cx="350" cy="182" rx="30" ry="6" fill="none" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="350" y="200" text-anchor="middle" font-size="8" fill="#92400e">Orders DB</text>
                                    
                                    <defs>
                                        <marker id="arr6" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                            <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            
                            <h4>Common Patterns</h4>
                            <ul>
                                <li><b>3-Tier:</b> Presentation → Business Logic → Data</li>
                                <li><b>Microservices:</b> API Gateway → Independent Services → Databases</li>
                                <li><b>ETL Pipeline:</b> Sources → Extract → Transform → Load → Destinations</li>
                            </ul>
                            
                            <div class="help-tip">
                                <b>Try:</b> Examples → Software Architecture or ETL Pipeline
                            </div>
                        }
                        else if (activeHelpSection == "keyboard")
                        {
                            <h3>⌨ Keyboard Shortcuts</h3>
                            <table class="help-table">
                                <tr><th>Shortcut</th><th>Action</th></tr>
                                <tr><td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td><td>Undo last action</td></tr>
                                <tr><td><kbd>Ctrl</kbd> + <kbd>Y</kbd></td><td>Redo</td></tr>
                                <tr><td><kbd>Delete</kbd></td><td>Delete selected items</td></tr>
                                <tr><td><kbd>Escape</kbd></td><td>Cancel operation / Deselect all</td></tr>
                                <tr><td><kbd>Scroll wheel</kbd></td><td>Zoom in/out</td></tr>
                                <tr><td><kbd>Shift</kbd> + <kbd>Click</kbd></td><td>Add to selection</td></tr>
                                <tr><td><kbd>Double-click</kbd></td><td>Edit node text</td></tr>
                                <tr><td><kbd>Drag on canvas</kbd></td><td>Selection box</td></tr>
                            </table>
                        }
                        else if (activeHelpSection == "export")
                        {
                            <h3>💾 Export Options</h3>
                            
                            <div class="help-illustration">
                                <svg viewBox="0 0 400 80" style="width:100%;max-width:400px;height:auto;">
                                    <rect x="10" y="10" width="110" height="60" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                                    <text x="65" y="35" text-anchor="middle" font-size="14" fill="#1e40af" font-weight="bold">PNG</text>
                                    <text x="65" y="52" text-anchor="middle" font-size="8" fill="#3b82f6">Images, docs</text>
                                    
                                    <rect x="140" y="10" width="110" height="60" rx="8" fill="#dcfce7" stroke="#059669" stroke-width="2"/>
                                    <text x="195" y="35" text-anchor="middle" font-size="14" fill="#065f46" font-weight="bold">SVG</text>
                                    <text x="195" y="52" text-anchor="middle" font-size="8" fill="#059669">Print, scalable</text>
                                    
                                    <rect x="270" y="10" width="110" height="60" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                                    <text x="325" y="35" text-anchor="middle" font-size="14" fill="#92400e" font-weight="bold">JSON</text>
                                    <text x="325" y="52" text-anchor="middle" font-size="8" fill="#f59e0b">Backup, share</text>
                                </svg>
                            </div>
                            
                            <table class="help-table">
                                <tr><th>Format</th><th>Best For</th></tr>
                                <tr><td><b>PNG</b></td><td>Word docs, PowerPoint, web pages. Use 2x scale for retina displays.</td></tr>
                                <tr><td><b>SVG</b></td><td>Print materials, infinite zoom, professional documents.</td></tr>
                                <tr><td><b>JSON</b></td><td>Save your work! Can be reimported to continue editing.</td></tr>
                            </table>
                            
                            <div class="help-warning">
                                <b>💡 Always save JSON</b> as backup before major changes! Use Export PDF to print.
                            </div>
                        }
                        else if (activeHelpSection == "tips")
                        {
                            <h3>💡 Tips & Best Practices</h3>
                            
                            <h4>✅ Do This</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 240 100" style="width:100%;max-width:240px;height:auto;">
                                    <rect x="10" y="10" width="220" height="80" rx="6" fill="#f0fdf4" stroke="#059669"/>
                                    <!-- Aligned nodes -->
                                    <rect x="25" y="25" width="50" height="25" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <rect x="95" y="25" width="50" height="25" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <rect x="165" y="25" width="50" height="25" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <path d="M75 37 L95 37" stroke="#374151" stroke-width="1" marker-end="url(#arr7)"/>
                                    <path d="M145 37 L165 37" stroke="#374151" stroke-width="1" marker-end="url(#arr7)"/>
                                    <text x="120" y="75" text-anchor="middle" font-size="9" fill="#065f46">Aligned, consistent, labeled</text>
                                    <defs>
                                        <marker id="arr7" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
                                            <polygon points="0 0, 8 3, 0 6" fill="#374151"/>
                                        </marker>
                                    </defs>
                                </svg>
                            </div>
                            <ul>
                                <li>Align nodes in rows/columns</li>
                                <li>Use consistent sizing for similar elements</li>
                                <li>Label ALL edges with data names</li>
                                <li>Stick to 3-4 colors with meaning</li>
                                <li>Leave white space between elements</li>
                            </ul>
                            
                            <h4>❌ Avoid This</h4>
                            <div class="help-illustration">
                                <svg viewBox="0 0 240 100" style="width:100%;max-width:240px;height:auto;">
                                    <rect x="10" y="10" width="220" height="80" rx="6" fill="#fef2f2" stroke="#dc2626"/>
                                    <!-- Misaligned nodes -->
                                    <rect x="20" y="20" width="40" height="20" rx="3" fill="white" stroke="#3b82f6" stroke-width="1.5"/>
                                    <rect x="100" y="35" width="60" height="35" rx="3" fill="white" stroke="#f59e0b" stroke-width="1.5"/>
                                    <rect x="180" y="15" width="35" height="25" rx="3" fill="white" stroke="#dc2626" stroke-width="1.5"/>
                                    <path d="M60 30 L100 52" stroke="#374151" stroke-width="1"/>
                                    <path d="M160 52 L180 27" stroke="#374151" stroke-width="1"/>
                                    <text x="120" y="80" text-anchor="middle" font-size="9" fill="#dc2626">Messy, unlabeled, inconsistent</text>
                                </svg>
                            </div>
                            <ul>
                                <li>❌ Unlabeled arrows</li>
                                <li>❌ Crossing lines everywhere</li>
                                <li>❌ Random sizes and positions</li>
                                <li>❌ Too many colors without meaning</li>
                            </ul>
                            
                            <h4>Pro Tips</h4>
                            <ul>
                                <li>🎯 Start with an Example and modify it</li>
                                <li>🔄 Use Undo freely - experiment!</li>
                                <li>📍 Use the minimap for large diagrams</li>
                                <li>💾 Save JSON backup before big changes</li>
                            </ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* ===== EXAMPLE GENERATOR MODAL (Ctrl+Shift+E) ===== *@
    @if (showExampleGenerator)
    {
        <div class="dialog-overlay" @onclick="CloseExampleGenerator">
            <div class="example-generator-modal" @onclick:stopPropagation="true">
                <div class="help-header">
                    <h2>🔧 Example Generator</h2>
                    <button class="modal-close-btn" @onclick="CloseExampleGenerator">✕</button>
                </div>
                
                @if (!examplePasswordVerified)
                {
                    <div class="password-section">
                        <p>Enter password to access example generator:</p>
                        <input type="password" 
                               @bind="examplePassword" 
                               @bind:event="oninput"
                               @onkeypress="@(e => { if (e.Key == "Enter") VerifyExamplePassword(); })"
                               placeholder="Password" />
                        <button class="btn-primary" @onclick="VerifyExamplePassword">Unlock</button>
                    </div>
                }
                else
                {
                    <div class="generator-content">
                        <div class="example-meta">
                            <div class="form-row">
                                <label>Key (lowercase, no spaces):</label>
                                <input type="text" @bind="newExampleKey" @bind:event="oninput" placeholder="myexample" />
                            </div>
                            <div class="form-row">
                                <label>Display Name:</label>
                                <input type="text" @bind="newExampleName" @bind:event="oninput" placeholder="My Example" />
                            </div>
                            <div class="form-row">
                                <label>Description:</label>
                                <input type="text" @bind="newExampleDescription" @bind:event="oninput" placeholder="What this example shows" />
                            </div>
                            <button class="btn-primary" @onclick="GenerateExampleCode">🔄 Regenerate Code</button>
                        </div>
                        
                        <div class="code-section">
                            <div class="code-header">
                                <span>Generated C# Code</span>
                                <button class="btn-copy" @onclick="CopyGeneratedCode">📋 Copy</button>
                            </div>
                            <pre class="code-output">@generatedExampleCode</pre>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .dfd-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f9fafb;
    }

    .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .side-panel {
        width: 220px;
        min-width: 220px;
        background: white;
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        position: relative;
        transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease;
    }

    .side-panel.collapsed {
        width: 32px;
        min-width: 32px;
        padding: 0.75rem 4px;
        overflow: hidden;
    }

    .panel-collapse-toggle {
        position: absolute;
        top: 8px;
        right: 4px;
        width: 24px;
        height: 24px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #6b7280;
        z-index: 10;
        transition: background 0.2s;
    }

    .panel-collapse-toggle:hover {
        background: #e5e7eb;
        color: #374151;
    }

    .side-panel.collapsed .panel-collapse-toggle {
        position: static;
        margin: 0 auto;
    }

    .right-panel .panel-collapse-toggle {
        right: auto;
        left: 4px;
    }

    .side-panel h3 {
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        margin: 0.5rem 0 0.5rem 0;
        padding-bottom: 0.35rem;
        border-bottom: 1px solid #e5e7eb;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .side-panel h3:first-child {
        margin-top: 0;
    }

    .side-panel .property-group {
        margin-bottom: 0.5rem;
    }

    .side-panel .property-group label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: block;
        margin-bottom: 0.3rem;
    }

    .side-panel .property-row,
    .side-panel .stat-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
    }

    .side-panel .property-row span:first-child,
    .side-panel .stat-row span:first-child {
        color: #6b7280;
    }

    .side-panel .property-row input {
        width: 70px;
        padding: 0.25rem 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        text-align: right;
    }

    .side-panel .panel-info {
        font-size: 0.9rem;
        color: #374151;
        margin: 0.5rem 0;
    }

    .side-panel .panel-hint {
        font-size: 0.8rem;
        color: #9ca3af;
        font-style: italic;
        margin: 0.25rem 0;
    }

    .side-panel .panel-select {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.85rem;
        background: white;
        margin-bottom: 0.5rem;
    }

    .side-panel .panel-select-small {
        flex: 1;
        padding: 0.3rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        background: white;
    }

    .side-panel .panel-color-picker {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
    }

    .side-panel .color-swatch-small {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .side-panel .color-swatch-small:hover {
        transform: scale(1.1);
    }

    .side-panel .color-swatch-small.selected {
        border-color: #1f2937;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #3b82f6;
    }

    .side-panel .panel-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: #374151;
        cursor: pointer;
    }

    .side-panel .panel-checkbox input {
        width: 16px;
        height: 16px;
    }

    .side-panel .panel-btn {
        width: 100%;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        background: #f9fafb;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 0.25rem;
    }

    .side-panel .panel-btn:hover {
        background: #f3f4f6;
    }

    .side-panel .panel-btn-primary {
        width: 100%;
        padding: 0.5rem;
        border: none;
        border-radius: 0.25rem;
        background: #3b82f6;
        color: white;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        margin-top: 0.5rem;
    }

    .side-panel .panel-btn-primary:hover {
        background: #2563eb;
    }

    .left-panel {
        border-right: 1px solid #e5e7eb;
    }

    .right-panel {
        border-left: 1px solid #e5e7eb;
    }
    .minimap-container {
        width: 100%;
        height: 150px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .minimap {
        width: 100%;
        height: 100%;
    }

    .property-textarea {
        width: 100%;
        min-height: 60px;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-family: Arial, sans-serif;
        font-size: 0.85rem;
        resize: vertical;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }

        .property-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

    .property-row {
        font-size: 0.8rem;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .btn-small {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border: none;
        border-radius: 0.25rem;
        background: #3b82f6;
        color: white;
        font-size: 0.8rem;
        cursor: pointer;
        margin-top: 0.5rem;
    }

        .btn-small:hover {
            background: #2563eb;
        }

    .toolbar {
        display: flex;
        align-items: center;
        gap: 2rem;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

        .toolbar h1 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin: 0;
        }

    .zoom-controls {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .zoom-controls button {
        width: 28px;
        height: 28px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zoom-controls button:hover:not(:disabled) {
        background: #e5e7eb;
    }

    .zoom-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .zoom-level {
        min-width: 45px;
        text-align: center;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .zoom-slider {
        width: 80px;
        height: 6px;
        cursor: pointer;
        accent-color: #3b82f6;
    }

    .zoom-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
    }

    .zoom-slider::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        border: none;
    }

    .toolbar-buttons {
        display: flex;
        gap: 0.5rem;
    }

        .toolbar-buttons button {
            padding: 0.35rem 0.7rem;
            border: none;
            border-radius: 0.375rem;
            background: #e5e7eb;
            color: #374151;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }

            .toolbar-buttons button:hover {
                background: #d1d5db;
            }

            .toolbar-buttons button.active {
                background: #3b82f6;
                color: white;
            }

    /* Toolbar Dropdown Menus */
    .toolbar-dropdown {
        position: relative;
        display: inline-block;
    }

    .toolbar-dropdown .dropdown-trigger {
        padding: 0.35rem 0.7rem;
        border: none;
        border-radius: 0.375rem;
        background: #e5e7eb;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .toolbar-dropdown .dropdown-trigger:hover {
        background: #d1d5db;
    }

    .toolbar-dropdown .dropdown-trigger.active {
        background: #3b82f6;
        color: white;
    }

    .toolbar-dropdown .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 180px;
        z-index: 1000;
        padding: 0.25rem 0;
        margin-top: 0.25rem;
    }

    .toolbar-dropdown:hover .dropdown-menu,
    .toolbar-dropdown:focus-within .dropdown-menu {
        display: block;
    }

    .toolbar-dropdown .dropdown-menu button {
        display: block;
        width: 100%;
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        color: #374151;
        text-align: left;
        cursor: pointer;
        font-size: 0.85rem;
    }

    .toolbar-dropdown .dropdown-menu button:hover {
        background: #f3f4f6;
    }

    .toolbar-dropdown .dropdown-menu button.active {
        background: #eff6ff;
        color: #3b82f6;
    }

    .toolbar-dropdown .dropdown-menu button.btn-danger {
        color: #dc2626;
    }

    .toolbar-dropdown .dropdown-menu button.btn-danger:hover {
        background: #fef2f2;
    }

    .dropdown-divider {
        height: 1px;
        background: #e5e7eb;
        margin: 0.25rem 0;
    }

    .dropdown-submenu {
        padding: 0.5rem 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .dropdown-submenu .submenu-label {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
        margin-top: 0.5rem;
    }

    .dropdown-submenu .submenu-label:first-child {
        margin-top: 0;
    }

    .dropdown-select {
        width: 100%;
        padding: 0.35rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        font-size: 0.85rem;
    }

    .dropdown-menu-wide {
        min-width: 280px;
    }

    .dropdown-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }

    .dropdown-row .submenu-label {
        font-size: 0.75rem;
        color: #6b7280;
        min-width: 70px;
    }

    .dropdown-row button {
        padding: 0.35rem 0.5rem !important;
        min-width: auto !important;
        width: auto !important;
        font-size: 0.8rem !important;
    }

    .dropdown-menu-right {
        left: auto;
        right: 0;
    }

    .toolbar-right {
        margin-left: auto;
    }

    /* Mode Indicator */
    .mode-indicator {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: #3b82f6;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 2rem;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        z-index: 100;
    }

    .multi-connect-indicator {
        background: #8b5cf6;
    }

    .chain-indicator {
        background: #3b82f6;
    }

    .shape-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

        .shape-selector label {
            font-weight: 500;
            color: #374151;
        }

    .shape-dropdown, .array-dropdown, .background-dropdown {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .background-dropdown-narrow {
        max-width: 180px;
    }

    .background-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

        .background-selector label {
            font-weight: 500;
            color: #374151;
        }

    .btn-config {
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 0.375rem;
        background: #3b82f6;
        color: white;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
    }

        .btn-config:hover {
            background: #2563eb;
        }

    .array-controls {
        display: flex;
        gap: 0.5rem;
        padding-left: 0.5rem;
        border-left: 1px solid #d1d5db;
    }

    .align-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 0.75rem;
        border-left: 2px solid #3b82f6;
        margin-left: 0.5rem;
    }

    .align-label {
        font-weight: 600;
        color: #3b82f6;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .align-group {
        display: flex;
        gap: 2px;
        background: #f3f4f6;
        padding: 2px;
        border-radius: 0.375rem;
    }

    .align-group button {
        padding: 0.4rem;
        border: none;
        border-radius: 0.25rem;
        background: transparent;
        color: #4b5563;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .align-group button:hover {
        background: #e5e7eb;
        color: #1f2937;
    }

    .align-group button:active {
        background: #3b82f6;
        color: white;
    }

    .align-group button svg {
        width: 16px;
        height: 16px;
    }

    .toolbar-actions {
        margin-left: auto;
        display: flex;
        gap: 0.5rem;
    }

    .btn-undo, .btn-save, .btn-load, .btn-help, .btn-delete, .btn-export, .btn-clear {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        color: white;
        cursor: pointer;
        font-weight: 500;
    }

    .btn-undo {
        background: #8b5cf6;
    }

        .btn-undo:hover:not(:disabled) {
            background: #7c3aed;
        }

    .btn-save {
        background: #0ea5e9;
    }

        .btn-save:hover {
            background: #0284c7;
        }

    .btn-load {
        background: #f59e0b;
    }

        .btn-load:hover {
            background: #d97706;
        }

    .btn-help {
        background: #06b6d4;
    }

        .btn-help:hover {
            background: #0891b2;
        }

    .btn-delete {
        background: #ef4444;
    }

        .btn-delete:hover:not(:disabled) {
            background: #dc2626;
        }

    .btn-export {
        background: #10b981;
    }

        .btn-export:hover {
            background: #059669;
        }

    .btn-clear {
        background: #f97316;
    }

        .btn-clear:hover {
            background: #ea580c;
        }

    .btn-undo:disabled, .btn-delete:disabled {
        background: #d1d5db;
        cursor: not-allowed;
    }

    .instructions {
        background: #eff6ff;
        border-bottom: 1px solid #bfdbfe;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: #1e40af;
    }

    .canvas {
        flex: 1;
        position: relative;
        overflow: auto;
        background: white;
        cursor: crosshair;
        min-height: 500px;
        width: 100%;
        height: calc(100vh - 200px);
    }

        .canvas.grid-background {
            background-image: linear-gradient(rgba(156, 163, 175, 0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(156, 163, 175, 0.2) 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: -1px -1px;
        }

    .svg-layer {
        position: absolute;
        inset: 0;
        width: 4000px;
        height: 4000px;
        pointer-events: none;
    }

        .svg-layer > * {
            pointer-events: auto;
        }

    .text-editor {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 100;
    }

    .edge-label {
        background: white;
        position: absolute;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

        .edge-label:hover {
            border-color: #93c5fd;
        }

        .edge-label.selected {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: #3b82f6;
        cursor: se-resize;
        border-radius: 0 0 0.375rem 0;
    }

        .resize-handle:hover {
            background: #2563eb;
        }

    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .dialog-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        max-width: 600px;
        max-height: 80vh;
        overflow: auto;
    }

        .dialog-content.help-dialog {
            max-width: 700px;
            max-height: 85vh;
        }

        .dialog-content h2 {
            margin-top: 0;
            color: #1f2937;
        }

        .dialog-content h3 {
            color: #3b82f6;
            margin-top: 1.5rem;
        }

        .dialog-content ul {
            line-height: 1.8;
        }

    .dialog-textarea {
        width: 100%;
        height: 300px;
        font-family: monospace;
        font-size: 12px;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 0.375rem;
    }

    .text-edit-dialog {
        min-width: 400px;
        max-width: 500px;
    }

    .text-edit-textarea {
        width: 100%;
        min-height: 120px;
        font-family: Arial, sans-serif;
        font-size: 14px;
        padding: 0.75rem;
        border: 2px solid #3b82f6;
        border-radius: 0.375rem;
        resize: vertical;
        line-height: 1.5;
    }

        .text-edit-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

    .dialog-actions, .dialog-buttons {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .btn-primary {
        padding: 0.5rem 1rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-primary:hover {
            background: #2563eb;
        }

    .btn-secondary, .btn-close, .btn-cancel {
        padding: 0.5rem 1rem;
        background: #6b7280;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-secondary:hover, .btn-close:hover, .btn-cancel:hover {
            background: #4b5563;
        }

    .btn-apply {
        padding: 0.5rem 1rem;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-apply:hover {
            background: #059669;
        }

    .btn-apply-all {
        padding: 0.5rem 1rem;
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
    }

        .btn-apply-all:hover {
            background: #d97706;
        }

    .error-message {
        color: #ef4444;
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    .edge-style-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 1rem;
        border-left: 2px solid #e5e7eb;
    }

        .edge-style-section label {
            font-weight: 500;
            color: #374151;
        }

    .edge-dropdown {
        padding: 0.4rem 0.6rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .color-picker {
        display: flex;
        gap: 0.25rem;
        padding: 0.25rem;
        background: #f9fafb;
        border-radius: 0.375rem;
    }

    .color-swatch {
        width: 24px;
        height: 24px;
        border: 2px solid #d1d5db;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .color-swatch:hover {
            border-color: #9ca3af;
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #3b82f6;
            border-width: 3px;
            transform: scale(1.15);
        }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
    }

    .apply-button {
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        background: #10b981;
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.875rem;
        width: 100%;
        transition: all 0.2s;
    }

        .apply-button:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .apply-button:active {
            transform: translateY(0);
        }

    .edge-style-section button {
        padding: 0.4rem 0.8rem;
        border: none;
        border-radius: 0.375rem;
        background: #e5e7eb;
        color: #374151;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.875rem;
    }

        .edge-style-section button:hover:not(:disabled) {
            background: #d1d5db;
        }

        .edge-style-section button.active {
            background: #3b82f6;
            color: white;
        }

        .edge-style-section button:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

    /* Edge Style Panel */
    .edge-style-panel {
        position: fixed;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 100;
        min-width: 300px;
    }

        .edge-style-panel h3 {
            margin: 0 0 1rem 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

    .panel-row {
        margin-bottom: 1rem;
    }

        .panel-row label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

    .panel-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

        .panel-buttons button {
            width: 100%;
        }

    .connector-preview {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 8px;
        margin: 8px 0 12px 0;
    }

    .connector-preview svg {
        display: block;
    }

    /* Size inputs for dialogs */
    .size-inputs {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

        .size-inputs span {
            color: #6b7280;
            font-size: 0.875rem;
        }

    .size-input {
        width: 70px;
        padding: 0.4rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }

    /* Config sections */
    .config-section {
        margin-bottom: 1.5rem;
    }

        .config-section label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

    .config-dropdown {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151;
        cursor: pointer;
    }

    .label-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
    }

    .selected-edge {
        stroke: #3b82f6 !important;
        stroke-width: 4 !important;
        filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.9));
    }
    .icon-picker-section {
        margin-top: 12px;
    }

    .icon-picker-section > label {
        display: block;
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .icon-picker {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        max-height: 180px;
        overflow-y: auto;
        padding: 6px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
    }

    .icon-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        padding: 0;
    }

    .icon-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: scale(1.05);
    }

    .icon-btn.selected {
        background: #eff6ff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .examples-dropdown {
        position: relative;
        display: inline-block;
    }

    .examples-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        min-width: 200px;
        padding: 4px;
    }

    .examples-menu button {
        display: block;
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
    }

    .examples-menu button:hover {
        background: #f3f4f6;
    }

    /* ===== HELP MODAL STYLES ===== */
    .help-modal {
        background: white;
        border-radius: 12px;
        width: 900px;
        max-width: 95vw;
        height: 75vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .help-header {
        padding: 16px 24px;
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 12px 12px 0 0;
    }

    .help-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .modal-close-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
    }

    .modal-close-btn:hover {
        background: rgba(255,255,255,0.3);
    }

    .help-body {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .help-nav {
        width: 200px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        padding: 12px;
        overflow-y: auto;
    }

    .help-nav-btn {
        display: block;
        width: 100%;
        padding: 10px 12px;
        border: none;
        background: transparent;
        text-align: left;
        cursor: pointer;
        border-radius: 6px;
        font-size: 13px;
        color: #475569;
        margin-bottom: 4px;
    }

    .help-nav-btn:hover {
        background: #e2e8f0;
    }

    .help-nav-btn.active {
        background: #3b82f6;
        color: white;
    }

    .help-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        line-height: 1.6;
    }

    .help-content h3 {
        margin: 0 0 16px 0;
        color: #1e40af;
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 8px;
    }

    .help-content h4 {
        margin: 20px 0 10px 0;
        color: #334155;
    }

    .help-content p {
        margin: 0 0 12px 0;
        color: #475569;
    }

    .help-content ul, .help-content ol {
        margin: 0 0 16px 0;
        padding-left: 24px;
        color: #475569;
    }

    .help-content li {
        margin-bottom: 6px;
    }

    .help-table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
        font-size: 13px;
    }

    .help-table th, .help-table td {
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        text-align: left;
    }

    .help-table th {
        background: #f1f5f9;
        font-weight: 600;
    }

    .help-content kbd {
        background: #1e293b;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
    }

    .help-illustration {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        display: flex;
        justify-content: center;
    }

    .help-illustration svg {
        max-width: 100%;
        height: auto;
    }

    .help-tip {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-left: 4px solid #059669;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 16px 0;
        color: #065f46;
    }

    .help-warning {
        background: #fef3c7;
        border: 1px solid #fde68a;
        border-left: 4px solid #f59e0b;
        border-radius: 6px;
        padding: 12px 16px;
        margin: 16px 0;
        color: #92400e;
    }

    /* ===== EXAMPLE GENERATOR STYLES ===== */
    .example-generator-modal {
        background: white;
        border-radius: 12px;
        width: 800px;
        max-width: 90vw;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .password-section {
        padding: 40px;
        text-align: center;
    }

    .password-section input {
        padding: 10px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        width: 200px;
        margin-right: 10px;
    }

    .password-section input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .generator-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .example-meta {
        background: #f8fafc;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
    }

    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .form-row label {
        width: 200px;
        font-weight: 500;
        color: #475569;
    }

    .form-row input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-row input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .code-section {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

    .code-header {
        background: #1e293b;
        color: white;
        padding: 10px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
    }

    .btn-copy {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .btn-copy:hover {
        background: #2563eb;
    }

    .code-output {
        background: #0f172a;
        color: #e2e8f0;
        padding: 16px;
        margin: 0;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 12px;
        line-height: 1.5;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre;
    }

    .example-meta .btn-primary {
        margin-top: 10px;
    }

    /* Layout Dropdown Section Headers */
    .dropdown-section-header {
        padding: 6px 12px 4px;
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    /* Layout Processing Overlay */
    .layout-processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .layout-processing-modal {
        background: white;
        padding: 24px 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 16px;
        font-weight: 500;
        color: #374151;
    }

    .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Collapsible Panel Sections */
    .panel-section {
        margin-bottom: 0.25rem;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .section-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: linear-gradient(to bottom, #f9fafb, #f3f4f6);
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: background 0.2s;
    }

    .section-header:hover {
        background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
    }

    .section-header span:first-child {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .collapse-icon {
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s;
    }

    .section-content {
        padding: 10px;
        background: white;
        border-top: 1px solid #e5e7eb;
    }

    /* Hide h3 within collapsible sections since we now use section-header */
    .panel-section h3 {
        display: none;
    }
</style>

<script>
    // High-Quality PDF Export via Print Dialog with optional area selection
    window.downloadPDFViaPrint = function(svgContent, x, y, width, height) {
        try {
            // Parse the SVG to modify if area is selected
            let finalSvgContent = svgContent;
            let svgWidth = 2000;
            let svgHeight = 2000;
            
            if (x !== null && y !== null && width !== null && height !== null) {
                // Create a viewBox that crops to the selected area
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;
                
                // Set viewBox to crop area
                svgElement.setAttribute('viewBox', `${x} ${y} ${width} ${height}`);
                svgElement.setAttribute('width', width);
                svgElement.setAttribute('height', height);
                
                svgWidth = width;
                svgHeight = height;
                
                // Serialize back to string
                finalSvgContent = new XMLSerializer().serializeToString(svgElement);
            }
            
            // Create a new window for printing with high-quality settings
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DFD Export - High Quality Print</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body { 
                            background: white;
                        }
                        
                        .print-container {
                            width: 100%;
                            height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 20px;
                        }
                        
                        svg {
                            max-width: 100%;
                            max-height: 100%;
                            height: auto;
                            border: 1px solid #ccc;
                            /* High-quality rendering hints */
                            shape-rendering: geometricPrecision;
                            text-rendering: geometricPrecision;
                            image-rendering: optimizeQuality;
                        }
                        
                        .print-info {
                            position: fixed;
                            top: 10px;
                            left: 10px;
                            background: #fff;
                            padding: 10px;
                            border: 2px solid #3b82f6;
                            border-radius: 8px;
                            font-family: Arial, sans-serif;
                            font-size: 14px;
                            z-index: 1000;
                        }
                        
                        .print-info strong {
                            color: #3b82f6;
                        }
                        
                        .print-buttons {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            display: flex;
                            gap: 10px;
                            z-index: 1000;
                        }
                        
                        .print-buttons button {
                            padding: 10px 20px;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.2s;
                        }
                        
                        .btn-print {
                            background: #3b82f6;
                            color: white;
                        }
                        
                        .btn-print:hover {
                            background: #2563eb;
                        }
                        
                        .btn-svg {
                            background: #10b981;
                            color: white;
                        }
                        
                        .btn-svg:hover {
                            background: #059669;
                        }
                        
                        @@media print {
                            body { 
                                padding: 0;
                            }
                            
                            .print-info,
                            .print-buttons {
                                display: none !important;
                            }
                            
                            .print-container {
                                padding: 0;
                                height: auto;
                                display: block;
                            }
                            
                            svg {
                                border: none;
                                width: 100% !important;
                                max-width: 100% !important;
                                height: auto !important;
                                display: block;
                                /* Maximum quality for print */
                                shape-rendering: geometricPrecision;
                                text-rendering: geometricPrecision;
                                color-rendering: optimizeQuality;
                            }
                            
                            @@page { 
                                margin: 0.5cm;
                                size: ${svgWidth > svgHeight ? 'landscape' : 'portrait'};
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-info">
                        <strong>💡 Pro Tip:</strong> For best quality, use "Save as PDF" instead of printing to a physical printer. 
                        SVG is vector-based and will be crisp at any zoom level!
                    </div>
                    
                    <div class="print-buttons">
                        <button class="btn-print" onclick="window.print()">🖨️ Print/Save PDF</button>
                        <button class="btn-svg" onclick="downloadSVG()">💾 Download SVG</button>
                    </div>
                    
                    <div class="print-container">
                        ${finalSvgContent}
                    </div>
                    
                    <script>
                        function downloadSVG() {
                            const svg = document.querySelector('svg');
                            const serializer = new XMLSerializer();
                            const svgString = serializer.serializeToString(svg);
                            const blob = new Blob([svgString], { type: 'image/svg+xml' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'diagram.svg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                        
                        // Auto-trigger print dialog after a delay
                        window.onload = function() {
                            setTimeout(() => {
                                // Don't auto-print, let user choose
                                console.log('Ready to print. Click the Print button or press Ctrl+P');
                            }, 500);
                        };
                        window.getScrollInfo = function(element) {
        return [element.scrollLeft, element.scrollTop, element.clientWidth, element.clientHeight];
    };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            console.log('Print preview opened with high-quality settings');
        } catch (error) {
            console.error('Error opening print dialog:', error);
            alert('Error opening print dialog: ' + error.message);
        }
    };

    // High-Resolution Print All - No selection required, maximum quality
    window.printAllHighResolution = function(svgContent) {
        try {
            // Parse SVG to get dimensions and enhance quality
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
            const svgElement = svgDoc.documentElement;
            
            // Get original dimensions
            const originalWidth = parseFloat(svgElement.getAttribute('width')) || 2000;
            const originalHeight = parseFloat(svgElement.getAttribute('height')) || 2000;
            
            // Set maximum quality attributes
            svgElement.setAttribute('shape-rendering', 'geometricPrecision');
            svgElement.setAttribute('text-rendering', 'geometricPrecision');
            svgElement.setAttribute('image-rendering', 'optimizeQuality');
            svgElement.setAttribute('color-rendering', 'optimizeQuality');
            
            // Serialize back to string
            const enhancedSvgContent = new XMLSerializer().serializeToString(svgElement);
            
            // Create high-resolution print window
            const printWindow = window.open('', '_blank', 'width=1400,height=900');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DFD Print All - Maximum Resolution</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body { 
                            background: white;
                            font-family: Arial, sans-serif;
                        }
                        
                        .print-container {
                            width: 100%;
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 40px;
                        }
                        
                        svg {
                            max-width: 100%;
                            max-height: 90vh;
                            height: auto;
                            border: 2px solid #e5e7eb;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                            background: white;
                            /* Maximum quality rendering */
                            shape-rendering: geometricPrecision;
                            text-rendering: geometricPrecision;
                            image-rendering: optimizeQuality;
                            color-rendering: optimizeQuality;
                        }
                        
                        .print-header {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 15px 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                            z-index: 1000;
                        }
                        
                        .print-header h1 {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0;
                        }
                        
                        .quality-badge {
                            background: rgba(255, 255, 255, 0.2);
                            padding: 5px 15px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: bold;
                            backdrop-filter: blur(10px);
                        }
                        
                        .print-info {
                            position: fixed;
                            bottom: 20px;
                            left: 20px;
                            background: white;
                            padding: 15px 20px;
                            border: 2px solid #10b981;
                            border-radius: 12px;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                            max-width: 400px;
                            z-index: 1000;
                        }
                        
                        .print-info h3 {
                            color: #10b981;
                            margin: 0 0 10px 0;
                            font-size: 16px;
                        }
                        
                        .print-info p {
                            margin: 5px 0;
                            font-size: 13px;
                            color: #374151;
                            line-height: 1.5;
                        }
                        
                        .print-buttons {
                            position: fixed;
                            top: 70px;
                            right: 20px;
                            display: flex;
                            flex-direction: column;
                            gap: 10px;
                            z-index: 1000;
                        }
                        
                        .print-buttons button {
                            padding: 12px 24px;
                            border: none;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                        }
                        
                        .btn-print {
                            background: #3b82f6;
                            color: white;
                        }
                        
                        .btn-print:hover {
                            background: #2563eb;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
                        }
                        
                        .btn-svg {
                            background: #10b981;
                            color: white;
                        }
                        
                        .btn-svg:hover {
                            background: #059669;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
                        }
                        
                        .btn-png {
                            background: #8b5cf6;
                            color: white;
                        }
                        
                        .btn-png:hover {
                            background: #7c3aed;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
                        }
                        
                        @@media print {
                            body { 
                                padding: 0;
                                background: white;
                            }
                            
                            .print-header,
                            .print-info,
                            .print-buttons {
                                display: none !important;
                            }
                            
                            .print-container {
                                padding: 0;
                                min-height: 0;
                                display: block;
                            }
                            
                            svg {
                                border: none !important;
                                box-shadow: none !important;
                                width: 100% !important;
                                max-width: 100% !important;
                                height: auto !important;
                                max-height: none !important;
                                display: block;
                                /* Ultra-high quality for print */
                                shape-rendering: geometricPrecision !important;
                                text-rendering: geometricPrecision !important;
                                color-rendering: optimizeQuality !important;
                                image-rendering: optimizeQuality !important;
                            }
                            
                            @@page { 
                                margin: 1cm;
                                size: ${originalWidth > originalHeight ? 'A3 landscape' : 'A3 portrait'};
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>🖨️ Print All - Maximum Resolution</h1>
                        <div class="quality-badge">⚡ ULTRA HIGH QUALITY</div>
                    </div>
                    
                    <div class="print-info">
                        <h3>💎 Maximum Quality Mode</h3>
                        <p><strong>Canvas size:</strong> ${originalWidth} × ${originalHeight} px</p>
                        <p><strong>Format:</strong> Vector (infinite resolution)</p>
                        <p><strong>Recommended:</strong> Download SVG for perfect quality at any size!</p>
                    </div>
                    
                    <div class="print-buttons">
                        <button class="btn-print" onclick="window.print()">
                            <span>🖨️</span> Print / Save PDF
                        </button>
                        <button class="btn-svg" onclick="downloadSVG()">
                            <span>💾</span> Download SVG
                        </button>
                        <button class="btn-png" onclick="downloadPNG()">
                            <span>🖼️</span> Download PNG (High-Res)
                        </button>
                    </div>
                    
                    <div class="print-container">
                        ${enhancedSvgContent}
                    </div>
<div class="dfd-editor" onkeydown="HandleKeyboardShortcut" tabindex="0">                    
                    <script>
                        function downloadSVG() {
                            const svg = document.querySelector('svg');
                            const serializer = new XMLSerializer();
                            const svgString = serializer.serializeToString(svg);
                            const blob = new Blob([svgString], { type: 'image/svg+xml' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'diagram-full-resolution.svg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }
                        
                        function downloadPNG() {
                            const svg = document.querySelector('svg');
                            const canvas = document.createElement('canvas');
                            
                            // High resolution: 3x for crisp output
                            const scale = 3;
                            canvas.width = ${originalWidth} * scale;
                            canvas.height = ${originalHeight} * scale;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.scale(scale, scale);
                            
                            const svgString = new XMLSerializer().serializeToString(svg);
                            const img = new Image();
                            const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                            const url = URL.createObjectURL(blob);
                            
                            img.onload = function() {
                                ctx.drawImage(img, 0, 0);
                                canvas.toBlob(function(pngBlob) {
                                    const pngUrl = URL.createObjectURL(pngBlob);
                                    const a = document.createElement('a');
                                    a.href = pngUrl;
                                    a.download = 'diagram-high-resolution.png';
                                    document.body.appendChild(a);
                                    a.click();
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(pngUrl);
                                    URL.revokeObjectURL(url);
                                }, 'image/png', 1.0);
                            };
                            
                            img.src = url;
                        }
                        
                        window.onload = function() {
                            console.log('High-resolution print preview ready');
                            console.log('Canvas size: ${originalWidth} × ${originalHeight} px');
                            console.log('Quality mode: MAXIMUM');
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            console.log('Maximum resolution print window opened');
        } catch (error) {
            console.error('Error in Print All:', error);
            alert('Error in Print All: ' + error.message);
        }
    };

    // Canvas-based PDF Export - Renders SVG to canvas first for reliable PDF output
    window.exportPdfViaCanvas = async function(svgContent) {
        try {
            // Parse and enhance the SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
            const svgElement = svgDoc.documentElement;
            
            // Get dimensions
            const width = parseFloat(svgElement.getAttribute('width')) || 2000;
            const height = parseFloat(svgElement.getAttribute('height')) || 2000;
            
            // Find bounds of actual content
            let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
            const allElements = svgElement.querySelectorAll('rect, ellipse, polygon, path, text');
            allElements.forEach(el => {
                const bbox = {
                    x: parseFloat(el.getAttribute('x') || el.getAttribute('cx') || '0') - (parseFloat(el.getAttribute('rx') || '0')),
                    y: parseFloat(el.getAttribute('y') || el.getAttribute('cy') || '0') - (parseFloat(el.getAttribute('ry') || '0')),
                    width: parseFloat(el.getAttribute('width') || el.getAttribute('rx') || '0') * 2,
                    height: parseFloat(el.getAttribute('height') || el.getAttribute('ry') || '0') * 2
                };
                if (bbox.x < minX) minX = bbox.x;
                if (bbox.y < minY) minY = bbox.y;
                if (bbox.x + bbox.width > maxX) maxX = bbox.x + bbox.width;
                if (bbox.y + bbox.height > maxY) maxY = bbox.y + bbox.height;
            });
            
            // Add padding
            const padding = 50;
            minX = Math.max(0, minX - padding);
            minY = Math.max(0, minY - padding);
            maxX = Math.min(width, maxX + padding);
            maxY = Math.min(height, maxY + padding);
            
            const cropWidth = maxX - minX || width;
            const cropHeight = maxY - minY || height;
            
            // Set viewBox for cropping
            svgElement.setAttribute('viewBox', `${minX} ${minY} ${cropWidth} ${cropHeight}`);
            svgElement.setAttribute('width', cropWidth);
            svgElement.setAttribute('height', cropHeight);
            
            // Ensure proper rendering attributes
            svgElement.setAttribute('shape-rendering', 'geometricPrecision');
            svgElement.setAttribute('text-rendering', 'geometricPrecision');
            
            const finalSvg = new XMLSerializer().serializeToString(svgElement);
            
            // Create canvas with high DPI
            const scale = 2; // 2x for better quality
            const canvas = document.createElement('canvas');
            canvas.width = cropWidth * scale;
            canvas.height = cropHeight * scale;
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, cropWidth, cropHeight);
            
            // Create image from SVG
            return new Promise((resolve, reject) => {
                const img = new Image();
                const blob = new Blob([finalSvg], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, cropWidth, cropHeight);
                    URL.revokeObjectURL(url);
                    
                    // Generate PDF using canvas data URL
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    
                    // Calculate PDF page size (fit to A4 or custom)
                    const pdfWidth = 297; // A4 landscape width in mm
                    const pdfHeight = 210; // A4 landscape height in mm
                    const imgAspect = cropWidth / cropHeight;
                    const pdfAspect = pdfWidth / pdfHeight;
                    
                    let finalWidth, finalHeight, offsetX, offsetY;
                    if (imgAspect > pdfAspect) {
                        finalWidth = pdfWidth - 20;
                        finalHeight = finalWidth / imgAspect;
                        offsetX = 10;
                        offsetY = (pdfHeight - finalHeight) / 2;
                    } else {
                        finalHeight = pdfHeight - 20;
                        finalWidth = finalHeight * imgAspect;
                        offsetX = (pdfWidth - finalWidth) / 2;
                        offsetY = 10;
                    }
                    
                    // Create download link with PNG (works as fallback)
                    const a = document.createElement('a');
                    a.href = imgData;
                    a.download = 'diagram-export.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    console.log('PNG exported successfully');
                    resolve();
                };
                
                img.onerror = function(e) {
                    URL.revokeObjectURL(url);
                    console.error('Error loading SVG:', e);
                    reject(new Error('Failed to render SVG'));
                };
                
                img.src = url;
            });
        } catch (error) {
            console.error('Error in canvas PDF export:', error);
            alert('Error exporting: ' + error.message);
        }
    };

    // Get scroll info for minimap viewport tracking
    window.getScrollInfo = function(element) {
        if (!element) return [0, 0, 800, 600];
        return [element.scrollLeft, element.scrollTop, element.clientWidth, element.clientHeight];
    };

    // Scroll canvas to specific position
    window.scrollCanvasTo = function(element, x, y) {
        if (!element) return;
        element.scrollLeft = x;
        element.scrollTop = y;
    };

    // Get minimap element bounds for coordinate conversion
    window.getMinimapBounds = function(element) {
        if (!element) return [0, 0, 150, 150];
        var rect = element.getBoundingClientRect();
        return [rect.left, rect.top, rect.width, rect.height];
    };
</script>

